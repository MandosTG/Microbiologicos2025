<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Control Microbiológico TIF - 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            display: flex;
        }
        .status-cumple {
            background-color: #dcfce7;
            color: #166534;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-no-cumple {
            background-color: #fee2e2;
            color: #991b1b;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #print-section, #print-section * {
                visibility: visible;
            }
            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Dashboard de Control Microbiológico TIF</h1>
                <p class="text-gray-500">Reporte Anual de Cumplimiento - 2025</p>
                 <p id="user-info" class="text-xs text-gray-400 mt-2"></p>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0 no-print">
                 <button id="add-record-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Añadir Registro
                </button>
                <button id="export-pdf-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    Exportar a PDF
                </button>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 no-print">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="proceso">Producto en Proceso</button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="inertes">Superficies Inertes</button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="vivas">Superficies Vivas</button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="ambiental">Ambiental</button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300" data-tab="plan">Plan de Acción</button>
                </nav>
            </div>
        </div>

        <main id="print-section">
            <!-- Content Sections -->
            <div id="tab-content">
                <div class="text-center py-10">
                    <div class="loader inline-block"></div>
                    <p class="mt-4 text-gray-600">Cargando datos, por favor espere...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para añadir datos -->
    <div id="data-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <p id="modal-title" class="text-2xl font-bold text-gray-800">Añadir Nuevo Registro</p>
                <button id="modal-close" class="cursor-pointer z-50 p-2 -mr-2">
                    <svg class="fill-current text-gray-500 hover:text-gray-800" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"/></svg>
                </button>
            </div>
            <div class="mt-4 max-h-[70vh] overflow-y-auto">
                <form id="data-form" class="space-y-4"></form>
            </div>
        </div>
    </div>
    
    <!-- PDF Loading Modal -->
    <div id="loading-modal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4">
            <div class="loader"></div>
            <span class="text-lg font-medium text-gray-700">Generando PDF, por favor espere...</span>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyD5AzipPkLYYl01Zfb4ydIdvsXhL01Orso",
          authDomain: "dashboard-tif-planta.firebaseapp.com",
          projectId: "dashboard-tif-planta",
          storageBucket: "dashboard-tif-planta.firebasestorage.app",
          messagingSenderId: "397966044077",
          appId: "1:397966044077:web:7ec49057199039f4eb0f24"
        };
        const appId = "dashboard-tif-planta"; // Using projectId as a unique identifier for the app instance.
        
        let app, auth, db, userId;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
            document.getElementById('tab-content').innerHTML = `<div class="text-center py-10 text-red-600">Error de configuración de Firebase. La aplicación no puede cargar.</div>`;
        }

        let dbData = { proceso: [], inertes: [], vivas: [], ambiental: [], plan: [] };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-info').textContent = `Conectado como: ${userId}`;
                setupFirestoreListeners();
            } else {
                 try {
                    // Sign in anonymously if no other user is present.
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error de autenticación:", error);
                    let errorMessage = "Error de autenticación. No se pueden cargar los datos.";
                    if (error.code === 'auth/configuration-not-found') {
                        errorMessage += "<br><br><b class='font-semibold'>Posible solución:</b> Asegúrate de haber habilitado el proveedor de 'Inicio de sesión anónimo' en la configuración de Autenticación de tu proyecto de Firebase. Ve a tu Consola de Firebase -> Authentication -> Sign-in method y habilita 'Anónimo'.";
                    }
                    document.getElementById('tab-content').innerHTML = `<div class="text-center p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">${errorMessage}</div>`;
                }
            }
        });
        
        // --- CONFIGURACIÓN DE LÍMITES Y PARÁMETROS ---
        const config = {
            proceso: { title: 'Producto en Proceso', limits: { mesofilos: 10000, coliformes: 500, ecoli: 500 }, unit: 'UFC/g' },
            inertes: { title: 'Superficies Inertes', limits: { mesofilos: 400, coliformes: 200 }, unit: 'UFC/cm²' },
            vivas: { title: 'Superficies Vivas', limits: { mesofilos: 3000, coliformes: 10, saureus: 0 }, unit: 'UFC/cm²' },
            ambiental: { title: 'Ambiental', limits: { mesofilos: 200, mohos: 100, listeria: 0 }, unit: 'UFC/cm³' },
            plan: { title: 'Plan de Acción' }
        };

        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        let activeTab = 'proceso';
        let charts = {};

        function setupFirestoreListeners() {
            Object.keys(dbData).forEach(collectionName => {
                const collRef = collection(db, `/artifacts/${appId}/public/data/${collectionName}`);
                onSnapshot(collRef, (snapshot) => {
                    const dataList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Para ordenar el plan de acción por fecha de creación
                    if (collectionName === 'plan') {
                        dataList.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    }
                    dbData[collectionName] = dataList;
                    // Solo renderiza si la pestaña activa corresponde a los datos que cambiaron
                    if(collectionName === activeTab || activeTab === 'plan'){
                         renderContent(activeTab);
                    }
                }, (error) => {
                    console.error(`Error al escuchar la colección ${collectionName}:`, error);
                });
            });
            // Render inicial después de configurar los listeners
            setTimeout(() => renderContent(activeTab), 1000);
        }

        // --- MANEJO DE TABS ---
        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                activeTab = tab.dataset.tab;
                document.getElementById('add-record-btn').style.display = (activeTab === 'plan') ? 'none' : 'flex';
                renderContent(activeTab);
            });
        });

        function setActiveTab(tabId) {
            tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
        }

        // --- LÓGICA DE RENDERIZADO ---
        function renderContent(tabId) {
            const tabContentContainer = document.getElementById('tab-content');
            setActiveTab(tabId);
            tabContentContainer.innerHTML = ''; 
            
            const sectionConfig = config[tabId];
            const data = dbData[tabId] || [];

            const container = document.createElement('div');
            container.id = `section-${tabId}`;
            container.className = 'bg-white p-6 rounded-lg shadow-md';

            let contentHTML = `<h2 class="text-2xl font-bold text-gray-700 mb-4">${sectionConfig.title}</h2>`;

            if (data.length === 0 && tabId !== 'plan') {
                contentHTML += `<p class="text-center text-gray-500 py-8">No hay datos registrados para esta sección todavía.</p>`;
            } else if (tabId !== 'plan') {
                contentHTML += `<div class="chart-container mb-6"><canvas id="chart-${tabId}"></canvas></div><div class="overflow-x-auto">${generateTableHTML(tabId, data)}</div>`;
            } else {
                 contentHTML += `<div class="overflow-x-auto">${generatePlanTableHTML(data)}</div>`;
            }
            
            container.innerHTML = contentHTML;
            tabContentContainer.appendChild(container);

            if (tabId !== 'plan' && data.length > 0) {
                renderChart(tabId, data);
            }
        }

        function generateTableHTML(tabId, data) {
            // ... (El código de las funciones generateTableHTML, getStatus y generatePlanTableHTML es idéntico a la versión anterior, no necesita cambios)
            let headers = ['Mes'];
            let bodyRows = '';
            const sectionConfig = config[tabId];

            if (tabId === 'proceso' || tabId === 'ambiental') {
                headers.push(...Object.keys(sectionConfig.limits).map(k => `${k.charAt(0).toUpperCase() + k.slice(1)} (${sectionConfig.unit})`), 'Cumplimiento');
                
                meses.forEach(mes => {
                    const monthData = data.find(d => d.mes === mes);
                    bodyRows += `<tr><td class="border px-4 py-2 font-medium">${mes}</td>`;
                    if (monthData) {
                        let overallStatus = true;
                        Object.keys(sectionConfig.limits).forEach(key => {
                            const value = monthData[key];
                            const limit = sectionConfig.limits[key];
                            if(value > limit) overallStatus = false;
                            bodyRows += `<td class="border px-4 py-2 text-center">${value ?? '-'}</td>`;
                        });
                        bodyRows += `<td class="border px-4 py-2 text-center">${overallStatus ? getStatus(0,1) : getStatus(1,0)}</td>`;
                    } else {
                        bodyRows += `<td class="border px-4 py-2 text-center" colspan="${Object.keys(sectionConfig.limits).length + 1}">Sin datos</td>`;
                    }
                    bodyRows += `</tr>`;
                });
            } else if (tabId === 'inertes') {
                headers.push('Mesofílicos aerobios (Resultados 1-4)', 'Coliformes totales (Resultados 1-4)', 'Cumplimiento');
                 meses.forEach(mes => {
                    const monthData = data.find(d => d.mes === mes);
                    bodyRows += `<tr><td class="border px-4 py-2 font-medium">${mes}</td>`;
                    if(monthData) {
                        const mesofilosMax = Math.max(...monthData.mesofilos);
                        const coliformesMax = Math.max(...monthData.coliformes);
                        const status = (mesofilosMax <= sectionConfig.limits.mesofilos && coliformesMax <= sectionConfig.limits.coliformes);
                        bodyRows += `<td class="border px-4 py-2 text-center">${monthData.mesofilos.join(', ')}</td>`;
                        bodyRows += `<td class="border px-4 py-2 text-center">${monthData.coliformes.join(', ')}</td>`;
                        bodyRows += `<td class="border px-4 py-2 text-center">${status ? getStatus(0,1) : getStatus(1,0)}</td>`;
                    } else {
                         bodyRows += `<td class="border px-4 py-2 text-center" colspan="3">Sin datos</td>`;
                    }
                    bodyRows += `</tr>`;
                });
            } else if (tabId === 'vivas') {
                 headers.push('Tipo de Muestra', 'Mesofílicos aerobios', 'Coliformes totales', 'S. Aureus', 'Cumplimiento');
                 meses.forEach(mes => {
                     const monthData = data.filter(d => d.mes === mes);
                     if (monthData.length > 0) {
                         monthData.forEach((sample, index) => {
                             const status = sample.mesofilos <= sectionConfig.limits.mesofilos && sample.coliformes <= sectionConfig.limits.coliformes && sample.saureus <= sectionConfig.limits.saureus;
                              bodyRows += `<tr>`;
                              if(index === 0) bodyRows += `<td class="border px-4 py-2 font-medium" rowspan="${monthData.length}">${mes}</td>`;
                              bodyRows += `<td class="border px-4 py-2">${sample.tipo}</td>`;
                              bodyRows += `<td class="border px-4 py-2 text-center">${sample.mesofilos}</td>`;
                              bodyRows += `<td class="border px-4 py-2 text-center">${sample.coliformes}</td>`;
                              bodyRows += `<td class="border px-4 py-2 text-center">${sample.saureus}</td>`;
                              bodyRows += `<td class="border px-4 py-2 text-center">${status ? getStatus(0,1) : getStatus(1,0)}</td>`;
                              bodyRows += `</tr>`;
                         });
                     } else {
                          bodyRows += `<tr><td class="border px-4 py-2 font-medium">${mes}</td><td class="border px-4 py-2 text-center" colspan="5">Sin datos</td></tr>`;
                     }
                 });
            }

            return `
                <table class="table-auto w-full text-left">
                    <thead class="bg-gray-100"><tr>${headers.map(h => `<th class="px-4 py-2">${h}</th>`).join('')}</tr></thead>
                    <tbody>${bodyRows}</tbody>
                </table>`;
        }
        
        function getStatus(value, limit) { return value > limit ? '<span class="status-no-cumple">No Cumple</span>' : '<span class="status-cumple">Cumple</span>'; }

        function generatePlanTableHTML(data) {
             const headers = ['Fecha', 'Muestreo', 'Hallazgo', 'Acción Correctiva', 'Responsable', 'Fecha Cierre', 'Estado'];
            let bodyRows = '';

            if (data.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No hay acciones correctivas pendientes. ¡Excelente trabajo!</p>';
            }

            data.forEach(item => {
                const status = item.cierre ? '<span class="status-cumple">Cerrado</span>' : '<span class="status-no-cumple">Abierto</span>';
                const fecha = item.fecha instanceof Date ? item.fecha.toLocaleDateString() : item.fecha;
                bodyRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="border px-4 py-3">${fecha}</td>
                        <td class="border px-4 py-3">${item.muestreo}</td>
                        <td class="border px-4 py-3">${item.hallazgo}</td>
                        <td class="border px-4 py-3">${item.accion || 'N/A'}</td>
                        <td class="border px-4 py-3">${item.responsable || 'N/A'}</td>
                        <td class="border px-4 py-3">${item.cierre || 'Pendiente'}</td>
                        <td class="border px-4 py-3 text-center">${status}</td>
                    </tr>`;
            });
            return `<table class="table-auto w-full text-sm"><thead class="bg-gray-100"><tr>${headers.map(h => `<th class="px-4 py-2 font-medium text-gray-600">${h}</th>`).join('')}</tr></thead><tbody>${bodyRows}</tbody></table>`;
        }

        function renderChart(tabId, rawData) {
            // ... (La lógica de renderChart es idéntica a la versión anterior, no necesita cambios)
             const data = [...rawData].sort((a,b) => meses.indexOf(a.mes) - meses.indexOf(b.mes));
            const ctx = document.getElementById(`chart-${tabId}`).getContext('2d');
            if (charts[tabId]) {
                charts[tabId].destroy();
            }

            const sectionConfig = config[tabId];
            let datasets = [];
            const chartLabels = data.map(d => d.mes);
            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6'];

            if (tabId === 'proceso' || tabId === 'ambiental') {
                Object.keys(sectionConfig.limits).forEach((key, index) => {
                    datasets.push({
                        label: `${key.charAt(0).toUpperCase() + key.slice(1)}`,
                        data: data.map(d => d[key]),
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '33',
                        tension: 0.1,
                        fill: false,
                    });
                    datasets.push({
                        label: `Límite ${key}`,
                        data: Array(data.length).fill(sectionConfig.limits[key]),
                        borderColor: colors[index % colors.length],
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                    });
                });
            } else if (tabId === 'inertes') {
                datasets.push({ label: 'Mesofílicos (Máx)', data: data.map(d => Math.max(...d.mesofilos)), borderColor: colors[0], tension: 0.1 });
                datasets.push({ label: 'Límite Mesofílicos', data: Array(data.length).fill(sectionConfig.limits.mesofilos), borderColor: colors[0], borderDash: [5, 5], pointRadius: 0 });
                datasets.push({ label: 'Coliformes (Máx)', data: data.map(d => Math.max(...d.coliformes)), borderColor: colors[1], tension: 0.1 });
                datasets.push({ label: 'Límite Coliformes', data: Array(data.length).fill(sectionConfig.limits.coliformes), borderColor: colors[1], borderDash: [5, 5], pointRadius: 0 });
            } else if (tabId === 'vivas') {
                 // Group data by month first
                const monthlyData = {};
                data.forEach(d => {
                    if (!monthlyData[d.mes]) {
                        monthlyData[d.mes] = { 'Manos en Proceso': {}, 'Manos Lavadas': {} };
                    }
                    monthlyData[d.mes][d.tipo] = d;
                });

                const labels = Object.keys(monthlyData).sort((a,b) => meses.indexOf(a) - meses.indexOf(b));
                const manosProcesoData = labels.map(mes => monthlyData[mes]['Manos en Proceso']?.mesofilos);
                const manosLavadasData = labels.map(mes => monthlyData[mes]['Manos Lavadas']?.mesofilos);

                datasets.push({ label: 'Mesofílicos (Proceso)', data: manosProcesoData, borderColor: colors[0], tension: 0.1 });
                datasets.push({ label: 'Mesofílicos (Lavadas)', data: manosLavadasData, borderColor: colors[2], tension: 0.1 });
                datasets.push({ label: `Límite Mesofílicos`, data: Array(labels.length).fill(sectionConfig.limits.mesofilos), borderColor: '#a1a1aa', borderDash: [5, 5], pointRadius: 0, fill: false });

            }

            charts[tabId] = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { title: { display: true, text: `Tendencia de Resultados vs Límites (${sectionConfig.unit})` }, legend: { position: 'bottom' } } }
            });
        }
        
        // --- MODAL Y FORMULARIOS ---
        const modal = document.getElementById('data-modal');
        const modalTitle = document.getElementById('modal-title');
        const form = document.getElementById('data-form');

        document.getElementById('add-record-btn').addEventListener('click', () => {
            modalTitle.textContent = `Añadir Registro para ${config[activeTab].title}`;
            generateForm(activeTab);
            modal.classList.add('active');
        });

        document.getElementById('modal-close').addEventListener('click', () => modal.classList.remove('active'));

        function generateForm(tabId) {
            form.innerHTML = '';
            const sectionConfig = config[tabId];
            let fieldsHTML = `
                <div>
                    <label for="mes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="mes" name="mes" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        ${meses.map(m => `<option value="${m}">${m}</option>`).join('')}
                    </select>
                </div>
            `;
            
            const inputField = (name, label, required = true) => `
                <div>
                    <label for="${name}" class="block text-sm font-medium text-gray-700">${label}</label>
                    <input type="number" name="${name}" id="${name}" ${required ? 'required' : ''} class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>`;
            
            if (tabId === 'proceso' || tabId === 'ambiental') {
                Object.keys(sectionConfig.limits).forEach(key => {
                    fieldsHTML += inputField(key, `${key.charAt(0).toUpperCase() + key.slice(1)} (${sectionConfig.unit})`);
                });
            } else if (tabId === 'inertes') {
                fieldsHTML += '<p class="text-sm font-medium text-gray-800">Mesofílicos Aerobios (4 Muestras)</p>';
                for(let i=1; i<=4; i++) fieldsHTML += inputField(`mesofilos_${i}`, `Resultado ${i}`);
                fieldsHTML += '<p class="text-sm font-medium text-gray-800 mt-4">Coliformes Totales (4 Muestras)</p>';
                for(let i=1; i<=4; i++) fieldsHTML += inputField(`coliformes_${i}`, `Resultado ${i}`);
            } else if (tabId === 'vivas') {
                 fieldsHTML += `
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700">Tipo de Muestra</label>
                        <select id="tipo" name="tipo" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="Manos en Proceso">Manos en Proceso</option>
                            <option value="Manos Lavadas">Manos Lavadas</option>
                        </select>
                    </div>
                `;
                 fieldsHTML += inputField('mesofilos', `Mesofílicos aerobios (${sectionConfig.unit})`);
                 fieldsHTML += inputField('coliformes', `Coliformes totales (${sectionConfig.unit})`);
                 fieldsHTML += inputField('saureus', `S. Aureus (${sectionConfig.unit})`);
            }

            fieldsHTML += `<button type="submit" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Guardar Registro</button>`;
            form.innerHTML = fieldsHTML;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = isNaN(parseFloat(value)) ? value : parseFloat(value);
            }

            const docId = data.mes + (data.tipo ? `_${data.tipo.replace(/\s+/g, '')}` : '');
            let dataToSave = { mes: data.mes };
            
            if (activeTab === 'inertes') {
                dataToSave.mesofilos = [data.mesofilos_1, data.mesofilos_2, data.mesofilos_3, data.mesofilos_4];
                dataToSave.coliformes = [data.coliformes_1, data.coliformes_2, data.coliformes_3, data.coliformes_4];
            } else if (activeTab === 'vivas') {
                dataToSave.tipo = data.tipo;
                Object.assign(dataToSave, { mesofilos: data.mesofilos, coliformes: data.coliformes, saureus: data.saureus });
            } else {
                 Object.assign(dataToSave, data);
            }
            
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/${activeTab}`, docId);
                await setDoc(docRef, dataToSave);
                await checkLimitsAndCreateActionPlan(dataToSave, activeTab);
                modal.classList.remove('active');
                alert('Registro guardado exitosamente.');
            } catch (error) {
                console.error("Error al guardar el documento: ", error);
                alert('Hubo un error al guardar el registro.');
            }
        });

        async function checkLimitsAndCreateActionPlan(data, type) {
            const sectionConfig = config[type];
            let findings = [];
            const today = new Date().toISOString().split('T')[0];

            if (type === 'proceso' || type === 'ambiental') {
                Object.keys(sectionConfig.limits).forEach(key => {
                    if (data[key] > sectionConfig.limits[key]) {
                        findings.push(`${key}: ${data[key]} ${sectionConfig.unit} (Límite: ${sectionConfig.limits[key]})`);
                    }
                });
            } else if (type === 'inertes') {
                const maxMesofilos = Math.max(...data.mesofilos);
                const maxColiformes = Math.max(...data.coliformes);
                if (maxMesofilos > sectionConfig.limits.mesofilos) findings.push(`Mesofílicos aerobios: ${maxMesofilos} ${sectionConfig.unit} (Límite: ${sectionConfig.limits.mesofilos})`);
                if (maxColiformes > sectionConfig.limits.coliformes) findings.push(`Coliformes totales: ${maxColiformes} ${sectionConfig.unit} (Límite: ${sectionConfig.limits.coliformes})`);
            } else if (type === 'vivas') {
                 if (data.mesofilos > sectionConfig.limits.mesofilos) findings.push(`Mesofílicos aerobios (${data.tipo}): ${data.mesofilos} ${sectionConfig.unit} (Límite: ${sectionConfig.limits.mesofilos})`);
                 if (data.coliformes > sectionConfig.limits.coliformes) findings.push(`Coliformes totales (${data.tipo}): ${data.coliformes} ${sectionConfig.unit} (Límite: ${sectionConfig.limits.coliformes})`);
                 if (data.saureus > sectionConfig.limits.saureus) findings.push(`S. Aureus (${data.tipo}): ${data.saureus} ${sectionConfig.unit} (Límite: ${sectionConfig.limits.saureus})`);
            }

            for (const finding of findings) {
                const planData = {
                    fecha: today,
                    muestreo: `${sectionConfig.title} - ${data.mes}`,
                    hallazgo: finding,
                    accion: '',
                    responsable: '',
                    cierre: '',
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, `/artifacts/${appId}/public/data/plan`), planData);
            }
        }
        
        // --- EXPORTAR A PDF ---
        document.getElementById('export-pdf-btn').addEventListener('click', () => {
             // ... (El código de exportar a PDF es idéntico a la versión anterior, no necesita cambios)
            const loadingModal = document.getElementById('loading-modal');
            loadingModal.classList.add('active');

            const { jsPDF } = window.jspdf;
            const originalTab = activeTab;
            
            const allSections = document.createElement('div');
            allSections.id = 'pdf-render-area';
            allSections.style.width = '1200px';

            Object.keys(config).forEach(key => {
                const sectionContainer = document.createElement('div');
                renderContentForPrinting(key, sectionContainer);
                allSections.appendChild(sectionContainer);
            });

            document.body.appendChild(allSections);
            
            html2canvas(allSections, { scale: 2, useCORS: true, windowWidth: 1200 }).then(canvas => {
                document.body.removeChild(allSections);
                renderContent(originalTab); // Restore view
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`Reporte_Microbiologico_TIF_2025.pdf`);
                loadingModal.classList.remove('active');
            }).catch(err => {
                 console.error("Error al generar el PDF:", err);
                 loadingModal.classList.remove('active');
                 if(document.getElementById('pdf-render-area')) document.body.removeChild(allSections);
                 renderContent(originalTab);
            });
        });

        function renderContentForPrinting(tabId, container) {
            const sectionConfig = config[tabId];
            const data = dbData[tabId] || [];
            
            container.className = 'bg-white p-6 rounded-lg shadow-md mt-8 page-break-before';
            let contentHTML = `<h2 class="text-2xl font-bold text-gray-700 mb-4">${sectionConfig.title}</h2>`;

            if (data.length === 0 && tabId !== 'plan') {
                contentHTML += `<p class="text-center text-gray-500 py-8">Sin datos</p>`
            } else if (tabId !== 'plan') {
                contentHTML += `<div class="chart-container mb-6" style="height: 300px;"><canvas id="chart-print-${tabId}"></canvas></div><div class="overflow-x-auto">${generateTableHTML(tabId, data)}</div>`;
            } else {
                 contentHTML += `<div class="overflow-x-auto">${generatePlanTableHTML(data)}</div>`;
            }
            container.innerHTML = contentHTML;
            if (tabId !== 'plan' && data.length > 0) {
                setTimeout(() => renderChart(`print-${tabId}`, data), 100);
            }
        }
    </script>
</body>
</html>

