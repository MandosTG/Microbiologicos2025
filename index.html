<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Microbiol√≥gico 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.herokuapp.com/dist/html2canvas.min.js"></script>
    <style>
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chart-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .json-editor {
            font-family: 'Courier New', monospace;
            background: #1f2937;
            color: #f9fafb;
        }
        .editor-tab-active {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white;
        }
        .editor-tab-inactive {
            background: #F3F4F6;
            color: #6B7280;
        }
        .editor-tab-inactive:hover {
            background: #E5E7EB;
            color: #374151;
        }
        .form-input {
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        .form-input.error {
            border-color: #EF4444;
            background-color: #FEF2F2;
        }
        .form-input.success {
            border-color: #10B981;
            background-color: #F0FDF4;
        }
        .month-card {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }
        .month-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .parameter-section {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .action-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="gradient-bg text-white p-6 shadow-lg no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold mb-2">üß™ Dashboard Microbiol√≥gico 2025</h1>
                <p class="text-blue-100">Control y seguimiento de an√°lisis microbiol√≥gicos</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportToPDF()" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                    üìÑ Exportar PDF
                </button>
                <button onclick="printFullReport()" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                    üñ®Ô∏è Imprimir Todo
                </button>
                <button onclick="toggleDataEditor()" id="editorToggle" class="bg-purple-800 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-900 transition-colors">
                    ‚öôÔ∏è Editor de Datos
                </button>
            </div>
        </div>
    </header>

    <!-- Data Editor Panel -->
    <div id="dataEditor" class="hidden no-print bg-gray-50 p-6">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">üìù Ingreso de Datos Microbiol√≥gicos</h2>
                    <p class="text-gray-600">Introduce los resultados de an√°lisis por mes y secci√≥n</p>
                </div>
                <div class="space-x-3">
                    <button onclick="saveAllData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium">
                        ‚úÖ Guardar y Actualizar
                    </button>
                    <button onclick="resetData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                        üîÑ Restaurar Datos
                    </button>
                    <button onclick="toggleJSONView()" id="jsonToggle" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium">
                        üìÑ Ver JSON
                    </button>
                </div>
            </div>

            <!-- Navegaci√≥n de secciones del editor -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="flex space-x-1 p-4 overflow-x-auto">
                    <button onclick="showEditorSection('producto')" id="editor-tab-producto" class="editor-tab-active px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üè≠ Producto en Proceso
                    </button>
                    <button onclick="showEditorSection('inertes')" id="editor-tab-inertes" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üßΩ Superficies Inertes
                    </button>
                    <button onclick="showEditorSection('vivas')" id="editor-tab-vivas" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üëê Superficies Vivas
                    </button>
                    <button onclick="showEditorSection('ambiental')" id="editor-tab-ambiental" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üå°Ô∏è Ambiental
                    </button>
                    <button onclick="showEditorSection('acciones')" id="editor-tab-acciones" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        ‚ö†Ô∏è Plan de Acci√≥n
                    </button>
                </div>
            </div>

            <!-- Secci√≥n Producto en Proceso -->
            <div id="editor-content-producto" class="editor-section">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üè≠ Producto en Proceso</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productoForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Superficies Inertes -->
            <div id="editor-content-inertes" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üßΩ Superficies Inertes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="inertesForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Superficies Vivas -->
            <div id="editor-content-vivas" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üëê Superficies Vivas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="vivasForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Ambiental -->
            <div id="editor-content-ambiental" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üå°Ô∏è Ambiental</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="ambientalForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Plan de Acci√≥n -->
            <div id="editor-content-acciones" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">‚ö†Ô∏è Plan de Acci√≥n</h3>
                        <button onclick="addNewAction()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚ûï Nueva Acci√≥n
                        </button>
                    </div>
                    <div id="accionesForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Vista JSON (oculta por defecto) -->
            <div id="jsonView" class="hidden bg-gray-800 text-white p-6 rounded-lg">
                <h3 class="text-lg font-bold mb-4">üìÑ Vista JSON (Avanzado)</h3>
                <textarea id="jsonData" class="json-editor w-full h-96 p-4 rounded-lg resize-none" placeholder="Datos JSON aqu√≠..."></textarea>
                <p class="text-gray-300 text-sm mt-2">üí° Solo para usuarios avanzados. Los cambios aqu√≠ sobrescribir√°n los formularios.</p>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-md sticky top-0 z-10 no-print">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex space-x-1 overflow-x-auto py-4">
                <button onclick="showTab('resumen')" id="tab-resumen" class="tab-active px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üìä Resumen General
                </button>
                <button onclick="showTab('producto')" id="tab-producto" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üè≠ Producto en Proceso
                </button>
                <button onclick="showTab('inertes')" id="tab-inertes" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üßΩ Superficies Inertes
                </button>
                <button onclick="showTab('vivas')" id="tab-vivas" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üëê Superficies Vivas
                </button>
                <button onclick="showTab('ambiental')" id="tab-ambiental" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üå°Ô∏è Ambiental
                </button>
                <button onclick="showTab('acciones')" id="tab-acciones" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    ‚ö†Ô∏è Plan de Acci√≥n
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6" id="mainContent">
        <!-- Resumen General Tab -->
        <div id="content-resumen" class="tab-content">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Resumen General - A√±o 2025</h2>
                <p class="text-gray-600">Estado general del cumplimiento microbiol√≥gico</p>
            </div>
            
            <!-- Indicadores Generales -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div id="cumplimiento-general" class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-green-600 text-2xl mr-3">‚úÖ</div>
                        <div>
                            <p class="text-sm text-green-600 font-medium">Cumplimiento General</p>
                            <p class="text-2xl font-bold text-green-700" id="cumplimiento-porcentaje">--</p>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-blue-600 text-2xl mr-3">üìä</div>
                        <div>
                            <p class="text-sm text-blue-600 font-medium">Muestras Analizadas</p>
                            <p class="text-2xl font-bold text-blue-700" id="total-muestras">--</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-yellow-600 text-2xl mr-3">‚ö†Ô∏è</div>
                        <div>
                            <p class="text-sm text-yellow-600 font-medium">No Conformidades</p>
                            <p class="text-2xl font-bold text-yellow-700" id="no-conformidades">--</p>
                        </div>
                    </div>
                </div>
                <div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-purple-600 text-2xl mr-3">üìã</div>
                        <div>
                            <p class="text-sm text-purple-600 font-medium">Acciones Correctivas</p>
                            <p class="text-2xl font-bold text-purple-700" id="acciones-correctivas">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos de Resumen -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üìà Tendencia de Cumplimiento Mensual</h3>
                    <canvas id="cumplimientoMensual" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üéØ Cumplimiento por √Årea</h3>
                    <canvas id="cumplimientoArea" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Producto en Proceso Tab -->
        <div id="content-producto" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Producto en Proceso</h2>
                <p class="text-gray-600">An√°lisis microbiol√≥gico del producto durante el proceso</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üìä Mes√≥filos Aerobios (L√≠mite: 10,000 UFC/g)</h3>
                    <canvas id="productoMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">ü¶† Coliformes Totales (L√≠mite: 500 UFC/g)</h3>
                    <canvas id="productoColiformes" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="chart-container p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">‚ö†Ô∏è E. coli (L√≠mite: 500 UFC/g)</h3>
                <canvas id="productoEcoli" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Superficies Inertes Tab -->
        <div id="content-inertes" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Superficies Inertes</h2>
                <p class="text-gray-600">Control microbiol√≥gico de superficies de contacto</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üßΩ Mes√≥filos Aerobios (L√≠mite: 400 UFC/cm¬≤)</h3>
                    <canvas id="inertesMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">ü¶† Coliformes Totales (L√≠mite: 200 UFC/cm¬≤)</h3>
                    <canvas id="inertesColiformes" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Superficies Vivas Tab -->
        <div id="content-vivas" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Superficies Vivas (Manos)</h2>
                <p class="text-gray-600">Control de higiene del personal manipulador</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üëê Mes√≥filos Aerobios (L√≠mite: 3,000 UFC/cm¬≤)</h3>
                    <canvas id="vivasMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">ü¶† Coliformes Totales (L√≠mite: 10 UFC/cm¬≤)</h3>
                    <canvas id="vivasColiformes" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="chart-container p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">‚ö†Ô∏è S. Aureus (L√≠mite: 0 UFC/cm¬≤)</h3>
                <canvas id="vivasAureus" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Ambiental Tab -->
        <div id="content-ambiental" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">An√°lisis Ambiental</h2>
                <p class="text-gray-600">Monitoreo de la calidad microbiol√≥gica del ambiente</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üå°Ô∏è Mes√≥filos Aerobios (L√≠mite: 200 UFC/cm¬≥)</h3>
                    <canvas id="ambientalMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üçÑ Mohos (L√≠mite: 100 UFC/cm¬≥)</h3>
                    <canvas id="ambientalMohos" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="chart-container p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">‚ö†Ô∏è Listeria (L√≠mite: 0 UFC/cm¬≥)</h3>
                <canvas id="ambientalListeria" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Plan de Acci√≥n Tab -->
        <div id="content-acciones" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Plan de Acci√≥n</h2>
                <p class="text-gray-600">Seguimiento de no conformidades y acciones correctivas</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="accionesTable">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Muestreo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resultado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n Correctiva</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsable</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="accionesTableBody">
                            <!-- Contenido din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 mt-12 no-print">
        <div class="max-w-7xl mx-auto text-center">
            <p class="text-gray-300">Dashboard Microbiol√≥gico 2025 - Sistema de Control de Calidad</p>
            <p class="text-sm text-gray-400 mt-2">√öltima actualizaci√≥n: <span id="lastUpdate"></span></p>
        </div>
    </footer>

    <script>
        // Configuraci√≥n global de Chart.js
        Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
        Chart.defaults.color = '#374151';

        // Datos por defecto
        const defaultData = {
            "productoEnProceso": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 10000,
                    "resultados": [8500, 7200, 9100, 6800, 7500, 8200, 7800, 8900, 7100, 8400, 7600, 8000]
                },
                "coliformesTotales": {
                    "limite": 500,
                    "resultados": [320, 280, 410, 350, 290, 380, 340, 420, 310, 360, 330, 370]
                },
                "eColi": {
                    "limite": 500,
                    "resultados": [45, 38, 52, 41, 35, 48, 42, 55, 39, 46, 40, 44]
                }
            },
            "superficiesInertes": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 400,
                    "resultado1": [320, 280, 350, 310, 290, 330, 300, 340, 285, 315, 295, 325],
                    "resultado2": [310, 275, 345, 305, 285, 325, 295, 335, 280, 310, 290, 320],
                    "resultado3": [315, 285, 355, 315, 295, 335, 305, 345, 290, 320, 300, 330],
                    "resultado4": [305, 270, 340, 300, 280, 320, 290, 330, 275, 305, 285, 315]
                },
                "coliformesTotales": {
                    "limite": 200,
                    "resultado1": [150, 130, 170, 140, 125, 160, 145, 175, 135, 155, 140, 165],
                    "resultado2": [145, 125, 165, 135, 120, 155, 140, 170, 130, 150, 135, 160],
                    "resultado3": [155, 135, 175, 145, 130, 165, 150, 180, 140, 160, 145, 170],
                    "resultado4": [140, 120, 160, 130, 115, 150, 135, 165, 125, 145, 130, 155]
                }
            },
            "superficiesVivas": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 3000,
                    "manosEnProceso": [2800, 2600, 2900, 2700, 2500, 2750, 2650, 2850, 2550, 2700, 2600, 2750],
                    "manosLavadas": [180, 150, 200, 170, 140, 190, 160, 210, 155, 185, 165, 195]
                },
                "coliformesTotales": {
                    "limite": 10,
                    "manosEnProceso": [8, 6, 9, 7, 5, 8, 6, 9, 5, 7, 6, 8],
                    "manosLavadas": [2, 1, 3, 2, 1, 2, 1, 3, 1, 2, 1, 2]
                },
                "sAureus": {
                    "limite": 0,
                    "manosEnProceso": [0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0],
                    "manosLavadas": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }
            },
            "ambiental": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 200,
                    "resultados": [180, 160, 190, 170, 150, 185, 165, 195, 155, 175, 160, 180]
                },
                "mohos": {
                    "limite": 100,
                    "resultados": [85, 75, 90, 80, 70, 88, 78, 92, 72, 82, 76, 85]
                },
                "listeria": {
                    "limite": 0,
                    "resultados": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }
            },
            "planAccion": [
                {
                    "fecha": "2025-03-15",
                    "muestreo": "SV",
                    "resultado": "S. Aureus: 1 UFC/cm¬≤ (L√≠mite: 0)",
                    "accionCorrectiva": "Reforzar capacitaci√≥n en lavado de manos",
                    "responsable": "Supervisor de Calidad",
                    "fechaCierre": "2025-03-20",
                    "estado": "Cerrada"
                },
                {
                    "fecha": "2025-08-10",
                    "muestreo": "SV",
                    "resultado": "S. Aureus: 1 UFC/cm¬≤ (L√≠mite: 0)",
                    "accionCorrectiva": "Revisi√≥n del protocolo de desinfecci√≥n",
                    "responsable": "Jefe de Producci√≥n",
                    "fechaCierre": "2025-08-15",
                    "estado": "Cerrada"
                }
            ]
        };

        let currentData = JSON.parse(JSON.stringify(defaultData));
        let charts = {};

        // Funciones de navegaci√≥n
        function showTab(tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remover clase activa de todas las pesta√±as
            document.querySelectorAll('nav button').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('bg-gray-100', 'hover:bg-gray-200');
            });
            
            // Mostrar contenido seleccionado
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Activar pesta√±a seleccionada
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('bg-gray-100', 'hover:bg-gray-200');
            
            // Inicializar gr√°ficos seg√∫n la pesta√±a
            setTimeout(() => initializeCharts(tabName), 100);
        }

        // Funci√≥n para alternar el editor de datos
        function toggleDataEditor() {
            const editor = document.getElementById('dataEditor');
            const toggle = document.getElementById('editorToggle');
            
            if (editor.classList.contains('hidden')) {
                editor.classList.remove('hidden');
                toggle.textContent = '‚ùå Cerrar Editor';
                document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
                initializeEditorForms();
                showEditorSection('producto');
            } else {
                editor.classList.add('hidden');
                toggle.textContent = '‚öôÔ∏è Editor de Datos';
            }
        }

        // Funci√≥n para mostrar secciones del editor
        function showEditorSection(section) {
            // Ocultar todas las secciones
            document.querySelectorAll('.editor-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            // Remover clase activa de todas las pesta√±as del editor
            document.querySelectorAll('[id^="editor-tab-"]').forEach(tab => {
                tab.classList.remove('editor-tab-active');
                tab.classList.add('editor-tab-inactive');
            });
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(`editor-content-${section}`).classList.remove('hidden');
            
            // Activar pesta√±a seleccionada
            const activeTab = document.getElementById(`editor-tab-${section}`);
            activeTab.classList.add('editor-tab-active');
            activeTab.classList.remove('editor-tab-inactive');
        }

        // Funci√≥n para alternar vista JSON
        function toggleJSONView() {
            const jsonView = document.getElementById('jsonView');
            const toggle = document.getElementById('jsonToggle');
            
            if (jsonView.classList.contains('hidden')) {
                jsonView.classList.remove('hidden');
                toggle.textContent = 'üìã Ver Formularios';
                document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
            } else {
                jsonView.classList.add('hidden');
                toggle.textContent = 'üìÑ Ver JSON';
            }
        }

        // Funci√≥n para actualizar gr√°ficos con nuevos datos
        function updateCharts() {
            try {
                const newData = JSON.parse(document.getElementById('jsonData').value);
                currentData = newData;
                
                // Destruir gr√°ficos existentes
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                // Reinicializar todos los gr√°ficos
                updateResumenGeneral();
                
                alert('‚úÖ Datos actualizados correctamente');
            } catch (error) {
                alert('‚ùå Error en el formato JSON: ' + error.message);
            }
        }

        // Funci√≥n para guardar todos los datos del formulario
        function saveAllData() {
            try {
                collectFormData();
                
                // Guardar datos en localStorage para persistencia
                localStorage.setItem('microbiologicalData', JSON.stringify(currentData));
                
                // Destruir gr√°ficos existentes
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                // Reinicializar todos los gr√°ficos
                updateResumenGeneral();
                
                // Actualizar vista JSON si est√° visible
                if (!document.getElementById('jsonView').classList.contains('hidden')) {
                    document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
                }
                
                // Actualizar fecha de √∫ltima modificaci√≥n
                const now = new Date().toLocaleString('es-ES');
                localStorage.setItem('lastUpdate', now);
                document.getElementById('lastUpdate').textContent = now;
                
                alert('‚úÖ Datos guardados permanentemente y gr√°ficos actualizados correctamente');
            } catch (error) {
                alert('‚ùå Error al guardar los datos: ' + error.message);
            }
        }

        // Funci√≥n para cargar datos guardados
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('microbiologicalData');
                const savedUpdate = localStorage.getItem('lastUpdate');
                
                if (savedData) {
                    currentData = JSON.parse(savedData);
                    console.log('‚úÖ Datos cargados desde almacenamiento local');
                }
                
                if (savedUpdate) {
                    document.getElementById('lastUpdate').textContent = savedUpdate;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è No se pudieron cargar datos guardados, usando datos por defecto');
                currentData = JSON.parse(JSON.stringify(defaultData));
            }
        }

        // Funci√≥n para auto-guardar datos cuando se modifican
        function autoSaveData() {
            try {
                collectFormData();
                localStorage.setItem('microbiologicalData', JSON.stringify(currentData));
                
                const now = new Date().toLocaleString('es-ES');
                localStorage.setItem('lastUpdate', now);
                document.getElementById('lastUpdate').textContent = now;
                
                console.log('üíæ Datos guardados autom√°ticamente');
            } catch (error) {
                console.log('‚ùå Error en auto-guardado:', error.message);
            }
        }

        // Funci√≥n para recopilar datos de los formularios
        function collectFormData() {
            // Recopilar datos de Producto en Proceso
            const meses = currentData.productoEnProceso.meses;
            
            // Producto en Proceso
            meses.forEach((mes, index) => {
                const mesofilosValue = document.getElementById(`producto-mesofilos-${index}`)?.value;
                const coliformesValue = document.getElementById(`producto-coliformes-${index}`)?.value;
                const ecoliValue = document.getElementById(`producto-ecoli-${index}`)?.value;
                
                if (mesofilosValue !== undefined) currentData.productoEnProceso.mesofilosAerobios.resultados[index] = parseFloat(mesofilosValue) || 0;
                if (coliformesValue !== undefined) currentData.productoEnProceso.coliformesTotales.resultados[index] = parseFloat(coliformesValue) || 0;
                if (ecoliValue !== undefined) currentData.productoEnProceso.eColi.resultados[index] = parseFloat(ecoliValue) || 0;
            });

            // Superficies Inertes
            meses.forEach((mes, index) => {
                for (let i = 1; i <= 4; i++) {
                    const mesofilosValue = document.getElementById(`inertes-mesofilos-${i}-${index}`)?.value;
                    const coliformesValue = document.getElementById(`inertes-coliformes-${i}-${index}`)?.value;
                    
                    if (mesofilosValue !== undefined) currentData.superficiesInertes.mesofilosAerobios[`resultado${i}`][index] = parseFloat(mesofilosValue) || 0;
                    if (coliformesValue !== undefined) currentData.superficiesInertes.coliformesTotales[`resultado${i}`][index] = parseFloat(coliformesValue) || 0;
                }
            });

            // Superficies Vivas
            meses.forEach((mes, index) => {
                const mesofilosProceso = document.getElementById(`vivas-mesofilos-proceso-${index}`)?.value;
                const mesofilosLavadas = document.getElementById(`vivas-mesofilos-lavadas-${index}`)?.value;
                const coliformesProceso = document.getElementById(`vivas-coliformes-proceso-${index}`)?.value;
                const coliformesLavadas = document.getElementById(`vivas-coliformes-lavadas-${index}`)?.value;
                const aureusProceso = document.getElementById(`vivas-aureus-proceso-${index}`)?.value;
                const aureusLavadas = document.getElementById(`vivas-aureus-lavadas-${index}`)?.value;
                
                if (mesofilosProceso !== undefined) currentData.superficiesVivas.mesofilosAerobios.manosEnProceso[index] = parseFloat(mesofilosProceso) || 0;
                if (mesofilosLavadas !== undefined) currentData.superficiesVivas.mesofilosAerobios.manosLavadas[index] = parseFloat(mesofilosLavadas) || 0;
                if (coliformesProceso !== undefined) currentData.superficiesVivas.coliformesTotales.manosEnProceso[index] = parseFloat(coliformesProceso) || 0;
                if (coliformesLavadas !== undefined) currentData.superficiesVivas.coliformesTotales.manosLavadas[index] = parseFloat(coliformesLavadas) || 0;
                if (aureusProceso !== undefined) currentData.superficiesVivas.sAureus.manosEnProceso[index] = parseFloat(aureusProceso) || 0;
                if (aureusLavadas !== undefined) currentData.superficiesVivas.sAureus.manosLavadas[index] = parseFloat(aureusLavadas) || 0;
            });

            // Ambiental
            meses.forEach((mes, index) => {
                const mesofilosValue = document.getElementById(`ambiental-mesofilos-${index}`)?.value;
                const mohosValue = document.getElementById(`ambiental-mohos-${index}`)?.value;
                const listeriaValue = document.getElementById(`ambiental-listeria-${index}`)?.value;
                
                if (mesofilosValue !== undefined) currentData.ambiental.mesofilosAerobios.resultados[index] = parseFloat(mesofilosValue) || 0;
                if (mohosValue !== undefined) currentData.ambiental.mohos.resultados[index] = parseFloat(mohosValue) || 0;
                if (listeriaValue !== undefined) currentData.ambiental.listeria.resultados[index] = parseFloat(listeriaValue) || 0;
            });

            // Plan de Acci√≥n
            collectActionData();
        }

        // Funci√≥n para restaurar datos por defecto
        function resetData() {
            if (confirm('¬øEst√°s seguro de que quieres restaurar los datos por defecto?')) {
                currentData = JSON.parse(JSON.stringify(defaultData));
                document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
                updateCharts();
            }
        }

        // Funci√≥n para verificar cumplimiento
        function checkCompliance(value, limit) {
            return value <= limit;
        }

        // Funci√≥n para calcular estad√≠sticas generales
        function updateResumenGeneral() {
            let totalMuestras = 0;
            let noConformidades = 0;
            let cumplimientos = 0;

            // Contar muestras y no conformidades de cada √°rea
            const areas = ['productoEnProceso', 'superficiesInertes', 'superficiesVivas', 'ambiental'];
            
            areas.forEach(area => {
                const areaData = currentData[area];
                if (areaData && areaData.meses) {
                    const mesesCount = areaData.meses.length;
                    
                    Object.keys(areaData).forEach(key => {
                        if (key !== 'meses' && typeof areaData[key] === 'object' && areaData[key].limite !== undefined) {
                            const parametro = areaData[key];
                            
                            Object.keys(parametro).forEach(subKey => {
                                if (subKey !== 'limite' && Array.isArray(parametro[subKey])) {
                                    totalMuestras += parametro[subKey].length;
                                    parametro[subKey].forEach(valor => {
                                        if (checkCompliance(valor, parametro.limite)) {
                                            cumplimientos++;
                                        } else {
                                            noConformidades++;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            });

            const cumplimientoGeneral = totalMuestras > 0 ? Math.round((cumplimientos / totalMuestras) * 100) : 0;
            const accionesCorrectivas = currentData.planAccion ? currentData.planAccion.length : 0;

            // Actualizar indicadores
            document.getElementById('cumplimiento-porcentaje').textContent = cumplimientoGeneral + '%';
            document.getElementById('total-muestras').textContent = totalMuestras;
            document.getElementById('no-conformidades').textContent = noConformidades;
            document.getElementById('acciones-correctivas').textContent = accionesCorrectivas;
        }

        // Funci√≥n para inicializar gr√°ficos
        function initializeCharts(tabName) {
            if (tabName === 'resumen') {
                updateResumenGeneral();
                createResumenCharts();
            } else if (tabName === 'producto') {
                createProductoCharts();
            } else if (tabName === 'inertes') {
                createInertesCharts();
            } else if (tabName === 'vivas') {
                createVivasCharts();
            } else if (tabName === 'ambiental') {
                createAmbientalCharts();
            } else if (tabName === 'acciones') {
                updateAccionesTable();
            }
        }

        // Crear gr√°ficos de resumen
        function createResumenCharts() {
            // Gr√°fico de cumplimiento mensual
            const ctxMensual = document.getElementById('cumplimientoMensual').getContext('2d');
            if (charts.cumplimientoMensual) charts.cumplimientoMensual.destroy();
            
            charts.cumplimientoMensual = new Chart(ctxMensual, {
                type: 'line',
                data: {
                    labels: currentData.productoEnProceso.meses,
                    datasets: [{
                        label: 'Cumplimiento (%)',
                        data: [95, 92, 88, 94, 96, 93, 91, 89, 97, 94, 95, 93],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje de Cumplimiento'
                            }
                        }
                    }
                }
            });

            // Gr√°fico de cumplimiento por √°rea
            const ctxArea = document.getElementById('cumplimientoArea').getContext('2d');
            if (charts.cumplimientoArea) charts.cumplimientoArea.destroy();
            
            charts.cumplimientoArea = new Chart(ctxArea, {
                type: 'doughnut',
                data: {
                    labels: ['Producto en Proceso', 'Superficies Inertes', 'Superficies Vivas', 'Ambiental'],
                    datasets: [{
                        data: [93, 95, 91, 97],
                        backgroundColor: ['#3B82F6', '#8B5CF6', '#F59E0B', '#10B981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Crear gr√°ficos de producto en proceso
        function createProductoCharts() {
            const data = currentData.productoEnProceso;
            
            // Mes√≥filos Aerobios
            const ctxMesofilos = document.getElementById('productoMesofilos').getContext('2d');
            if (charts.productoMesofilos) charts.productoMesofilos.destroy();
            
            charts.productoMesofilos = new Chart(ctxMesofilos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.mesofilosAerobios.resultados,
                        backgroundColor: data.mesofilosAerobios.resultados.map(val => 
                            checkCompliance(val, data.mesofilosAerobios.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/g'
                            }
                        }
                    }
                }
            });

            // Coliformes Totales
            const ctxColiformes = document.getElementById('productoColiformes').getContext('2d');
            if (charts.productoColiformes) charts.productoColiformes.destroy();
            
            charts.productoColiformes = new Chart(ctxColiformes, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.coliformesTotales.resultados,
                        backgroundColor: data.coliformesTotales.resultados.map(val => 
                            checkCompliance(val, data.coliformesTotales.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.coliformesTotales.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/g'
                            }
                        }
                    }
                }
            });

            // E. coli
            const ctxEcoli = document.getElementById('productoEcoli').getContext('2d');
            if (charts.productoEcoli) charts.productoEcoli.destroy();
            
            charts.productoEcoli = new Chart(ctxEcoli, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.eColi.resultados,
                        backgroundColor: data.eColi.resultados.map(val => 
                            checkCompliance(val, data.eColi.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.eColi.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/g'
                            }
                        }
                    }
                }
            });
        }

        // Crear gr√°ficos de superficies inertes
        function createInertesCharts() {
            const data = currentData.superficiesInertes;
            
            // Mes√≥filos Aerobios
            const ctxMesofilos = document.getElementById('inertesMesofilos').getContext('2d');
            if (charts.inertesMesofilos) charts.inertesMesofilos.destroy();
            
            charts.inertesMesofilos = new Chart(ctxMesofilos, {
                type: 'line',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultado 1',
                        data: data.mesofilosAerobios.resultado1,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }, {
                        label: 'Resultado 2',
                        data: data.mesofilosAerobios.resultado2,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)'
                    }, {
                        label: 'Resultado 3',
                        data: data.mesofilosAerobios.resultado3,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)'
                    }, {
                        label: 'Resultado 4',
                        data: data.mesofilosAerobios.resultado4,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });

            // Coliformes Totales
            const ctxColiformes = document.getElementById('inertesColiformes').getContext('2d');
            if (charts.inertesColiformes) charts.inertesColiformes.destroy();
            
            charts.inertesColiformes = new Chart(ctxColiformes, {
                type: 'line',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultado 1',
                        data: data.coliformesTotales.resultado1,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }, {
                        label: 'Resultado 2',
                        data: data.coliformesTotales.resultado2,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)'
                    }, {
                        label: 'Resultado 3',
                        data: data.coliformesTotales.resultado3,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)'
                    }, {
                        label: 'Resultado 4',
                        data: data.coliformesTotales.resultado4,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.coliformesTotales.limite),
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });
        }

        // Crear gr√°ficos de superficies vivas
        function createVivasCharts() {
            const data = currentData.superficiesVivas;
            
            // Mes√≥filos Aerobios
            const ctxMesofilos = document.getElementById('vivasMesofilos').getContext('2d');
            if (charts.vivasMesofilos) charts.vivasMesofilos.destroy();
            
            charts.vivasMesofilos = new Chart(ctxMesofilos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Manos en Proceso',
                        data: data.mesofilosAerobios.manosEnProceso,
                        backgroundColor: '#F59E0B'
                    }, {
                        label: 'Manos Lavadas',
                        data: data.mesofilosAerobios.manosLavadas,
                        backgroundColor: '#10B981'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });

            // Coliformes Totales
            const ctxColiformes = document.getElementById('vivasColiformes').getContext('2d');
            if (charts.vivasColiformes) charts.vivasColiformes.destroy();
            
            charts.vivasColiformes = new Chart(ctxColiformes, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Manos en Proceso',
                        data: data.coliformesTotales.manosEnProceso,
                        backgroundColor: '#F59E0B'
                    }, {
                        label: 'Manos Lavadas',
                        data: data.coliformesTotales.manosLavadas,
                        backgroundColor: '#10B981'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.coliformesTotales.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });

            // S. Aureus
            const ctxAureus = document.getElementById('vivasAureus').getContext('2d');
            if (charts.vivasAureus) charts.vivasAureus.destroy();
            
            charts.vivasAureus = new Chart(ctxAureus, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Manos en Proceso',
                        data: data.sAureus.manosEnProceso,
                        backgroundColor: data.sAureus.manosEnProceso.map(val => 
                            checkCompliance(val, data.sAureus.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'Manos Lavadas',
                        data: data.sAureus.manosLavadas,
                        backgroundColor: data.sAureus.manosLavadas.map(val => 
                            checkCompliance(val, data.sAureus.limite) ? '#10B981' : '#EF4444'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });
        }

        // Crear gr√°ficos ambientales
        function createAmbientalCharts() {
            const data = currentData.ambiental;
            
            // Mes√≥filos Aerobios
            const ctxMesofilos = document.getElementById('ambientalMesofilos').getContext('2d');
            if (charts.ambientalMesofilos) charts.ambientalMesofilos.destroy();
            
            charts.ambientalMesofilos = new Chart(ctxMesofilos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.mesofilosAerobios.resultados,
                        backgroundColor: data.mesofilosAerobios.resultados.map(val => 
                            checkCompliance(val, data.mesofilosAerobios.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≥'
                            }
                        }
                    }
                }
            });

            // Mohos
            const ctxMohos = document.getElementById('ambientalMohos').getContext('2d');
            if (charts.ambientalMohos) charts.ambientalMohos.destroy();
            
            charts.ambientalMohos = new Chart(ctxMohos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.mohos.resultados,
                        backgroundColor: data.mohos.resultados.map(val => 
                            checkCompliance(val, data.mohos.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mohos.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≥'
                            }
                        }
                    }
                }
            });

            // Listeria
            const ctxListeria = document.getElementById('ambientalListeria').getContext('2d');
            if (charts.ambientalListeria) charts.ambientalListeria.destroy();
            
            charts.ambientalListeria = new Chart(ctxListeria, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.listeria.resultados,
                        backgroundColor: data.listeria.resultados.map(val => 
                            checkCompliance(val, data.listeria.limite) ? '#10B981' : '#EF4444'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≥'
                            }
                        }
                    }
                }
            });
        }

        // Actualizar tabla de acciones
        function updateAccionesTable() {
            const tbody = document.getElementById('accionesTableBody');
            tbody.innerHTML = '';
            
            currentData.planAccion.forEach(accion => {
                const row = document.createElement('tr');
                const estadoClass = accion.estado === 'Cerrada' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accion.fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accion.muestreo}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${accion.resultado}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${accion.accionCorrectiva}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accion.responsable}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${estadoClass}">
                            ${accion.estado}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Funci√≥n para exportar a PDF completo
        async function exportToPDF() {
            try {
                // Mostrar mensaje de progreso
                const originalText = document.querySelector('button[onclick="exportToPDF()"]').textContent;
                document.querySelector('button[onclick="exportToPDF()"]').textContent = '‚è≥ Generando PDF...';
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                let currentPage = 1;
                
                // Funci√≥n para agregar encabezado en cada p√°gina
                function addHeader(pageNum) {
                    pdf.setFontSize(16);
                    pdf.setTextColor(102, 126, 234);
                    pdf.text('üß™ Dashboard Microbiol√≥gico 2025', 20, 15);
                    pdf.setFontSize(10);
                    pdf.setTextColor(128, 128, 128);
                    pdf.text(`P√°gina ${pageNum} - Generado: ${new Date().toLocaleDateString('es-ES')}`, 20, 25);
                    pdf.setTextColor(0, 0, 0);
                }
                
                // P√°gina 1: Resumen General
                addHeader(currentPage);
                pdf.setFontSize(18);
                pdf.text('üìä RESUMEN GENERAL', 20, 40);
                
                pdf.setFontSize(12);
                const cumplimiento = document.getElementById('cumplimiento-porcentaje').textContent;
                const totalMuestras = document.getElementById('total-muestras').textContent;
                const noConformidades = document.getElementById('no-conformidades').textContent;
                const acciones = document.getElementById('acciones-correctivas').textContent;
                
                pdf.text(`‚úÖ Cumplimiento General: ${cumplimiento}`, 20, 55);
                pdf.text(`üìä Total de Muestras Analizadas: ${totalMuestras}`, 20, 65);
                pdf.text(`‚ö†Ô∏è No Conformidades Detectadas: ${noConformidades}`, 20, 75);
                pdf.text(`üìã Acciones Correctivas Implementadas: ${acciones}`, 20, 85);
                
                // Agregar datos detallados por secci√≥n
                let yPos = 100;
                
                // Producto en Proceso
                pdf.setFontSize(14);
                pdf.text('üè≠ PRODUCTO EN PROCESO', 20, yPos);
                yPos += 10;
                
                pdf.setFontSize(10);
                const productoData = currentData.productoEnProceso;
                productoData.meses.forEach((mes, index) => {
                    if (yPos > 250) {
                        pdf.addPage();
                        currentPage++;
                        addHeader(currentPage);
                        yPos = 40;
                    }
                    
                    const mesofilos = productoData.mesofilosAerobios.resultados[index];
                    const coliformes = productoData.coliformesTotales.resultados[index];
                    const ecoli = productoData.eColi.resultados[index];
                    
                    pdf.text(`${mes}: Mes√≥filos: ${mesofilos} UFC/g, Coliformes: ${coliformes} UFC/g, E.coli: ${ecoli} UFC/g`, 25, yPos);
                    yPos += 8;
                });
                
                // Nueva p√°gina para Superficies Inertes
                pdf.addPage();
                currentPage++;
                addHeader(currentPage);
                yPos = 40;
                
                pdf.setFontSize(14);
                pdf.text('üßΩ SUPERFICIES INERTES', 20, yPos);
                yPos += 10;
                
                pdf.setFontSize(10);
                const inertesData = currentData.superficiesInertes;
                inertesData.meses.forEach((mes, index) => {
                    if (yPos > 240) {
                        pdf.addPage();
                        currentPage++;
                        addHeader(currentPage);
                        yPos = 40;
                    }
                    
                    pdf.text(`${mes}:`, 25, yPos);
                    yPos += 6;
                    
                    for (let i = 1; i <= 4; i++) {
                        const mesofilos = inertesData.mesofilosAerobios[`resultado${i}`][index];
                        const coliformes = inertesData.coliformesTotales[`resultado${i}`][index];
                        pdf.text(`  Resultado ${i}: Mes√≥filos: ${mesofilos} UFC/cm¬≤, Coliformes: ${coliformes} UFC/cm¬≤`, 30, yPos);
                        yPos += 5;
                    }
                    yPos += 3;
                });
                
                // Nueva p√°gina para Superficies Vivas
                pdf.addPage();
                currentPage++;
                addHeader(currentPage);
                yPos = 40;
                
                pdf.setFontSize(14);
                pdf.text('üëê SUPERFICIES VIVAS (MANOS)', 20, yPos);
                yPos += 10;
                
                pdf.setFontSize(10);
                const vivasData = currentData.superficiesVivas;
                vivasData.meses.forEach((mes, index) => {
                    if (yPos > 230) {
                        pdf.addPage();
                        currentPage++;
                        addHeader(currentPage);
                        yPos = 40;
                    }
                    
                    pdf.text(`${mes}:`, 25, yPos);
                    yPos += 6;
                    
                    const mesofilosProceso = vivasData.mesofilosAerobios.manosEnProceso[index];
                    const mesofilosLavadas = vivasData.mesofilosAerobios.manosLavadas[index];
                    const coliformesProceso = vivasData.coliformesTotales.manosEnProceso[index];
                    const coliformesLavadas = vivasData.coliformesTotales.manosLavadas[index];
                    const aureusProceso = vivasData.sAureus.manosEnProceso[index];
                    const aureusLavadas = vivasData.sAureus.manosLavadas[index];
                    
                    pdf.text(`  Manos en Proceso: Mes√≥filos: ${mesofilosProceso}, Coliformes: ${coliformesProceso}, S.Aureus: ${aureusProceso}`, 30, yPos);
                    yPos += 5;
                    pdf.text(`  Manos Lavadas: Mes√≥filos: ${mesofilosLavadas}, Coliformes: ${coliformesLavadas}, S.Aureus: ${aureusLavadas}`, 30, yPos);
                    yPos += 8;
                });
                
                // Nueva p√°gina para Ambiental
                pdf.addPage();
                currentPage++;
                addHeader(currentPage);
                yPos = 40;
                
                pdf.setFontSize(14);
                pdf.text('üå°Ô∏è AN√ÅLISIS AMBIENTAL', 20, yPos);
                yPos += 10;
                
                pdf.setFontSize(10);
                const ambientalData = currentData.ambiental;
                ambientalData.meses.forEach((mes, index) => {
                    if (yPos > 250) {
                        pdf.addPage();
                        currentPage++;
                        addHeader(currentPage);
                        yPos = 40;
                    }
                    
                    const mesofilos = ambientalData.mesofilosAerobios.resultados[index];
                    const mohos = ambientalData.mohos.resultados[index];
                    const listeria = ambientalData.listeria.resultados[index];
                    
                    pdf.text(`${mes}: Mes√≥filos: ${mesofilos} UFC/cm¬≥, Mohos: ${mohos} UFC/cm¬≥, Listeria: ${listeria} UFC/cm¬≥`, 25, yPos);
                    yPos += 8;
                });
                
                // Nueva p√°gina para Plan de Acci√≥n
                if (currentData.planAccion && currentData.planAccion.length > 0) {
                    pdf.addPage();
                    currentPage++;
                    addHeader(currentPage);
                    yPos = 40;
                    
                    pdf.setFontSize(14);
                    pdf.text('‚ö†Ô∏è PLAN DE ACCI√ìN CORRECTIVA', 20, yPos);
                    yPos += 15;
                    
                    pdf.setFontSize(10);
                    currentData.planAccion.forEach((accion, index) => {
                        if (yPos > 220) {
                            pdf.addPage();
                            currentPage++;
                            addHeader(currentPage);
                            yPos = 40;
                        }
                        
                        pdf.setFontSize(12);
                        pdf.text(`Acci√≥n Correctiva #${index + 1}`, 20, yPos);
                        yPos += 8;
                        
                        pdf.setFontSize(10);
                        pdf.text(`üìÖ Fecha: ${accion.fecha}`, 25, yPos);
                        yPos += 5;
                        pdf.text(`üî¨ Tipo de Muestreo: ${accion.muestreo}`, 25, yPos);
                        yPos += 5;
                        pdf.text(`üìä Resultado: ${accion.resultado}`, 25, yPos);
                        yPos += 5;
                        
                        // Dividir texto largo en m√∫ltiples l√≠neas
                        const accionLines = pdf.splitTextToSize(`üîß Acci√≥n Correctiva: ${accion.accionCorrectiva}`, 160);
                        pdf.text(accionLines, 25, yPos);
                        yPos += accionLines.length * 5;
                        
                        pdf.text(`üë§ Responsable: ${accion.responsable}`, 25, yPos);
                        yPos += 5;
                        pdf.text(`‚úÖ Fecha de Cierre: ${accion.fechaCierre}`, 25, yPos);
                        yPos += 5;
                        pdf.text(`üìã Estado: ${accion.estado}`, 25, yPos);
                        yPos += 15;
                    });
                }
                
                // P√°gina final con l√≠mites de referencia
                pdf.addPage();
                currentPage++;
                addHeader(currentPage);
                yPos = 40;
                
                pdf.setFontSize(14);
                pdf.text('üìã L√çMITES DE REFERENCIA', 20, yPos);
                yPos += 15;
                
                pdf.setFontSize(10);
                pdf.text('üè≠ Producto en Proceso:', 20, yPos);
                yPos += 6;
                pdf.text('  ‚Ä¢ Mes√≥filos Aerobios: ‚â§ 10,000 UFC/g', 25, yPos);
                yPos += 5;
                pdf.text('  ‚Ä¢ Coliformes Totales: ‚â§ 500 UFC/g', 25, yPos);
                yPos += 5;
                pdf.text('  ‚Ä¢ E. coli: ‚â§ 500 UFC/g', 25, yPos);
                yPos += 10;
                
                pdf.text('üßΩ Superficies Inertes:', 20, yPos);
                yPos += 6;
                pdf.text('  ‚Ä¢ Mes√≥filos Aerobios: ‚â§ 400 UFC/cm¬≤', 25, yPos);
                yPos += 5;
                pdf.text('  ‚Ä¢ Coliformes Totales: ‚â§ 200 UFC/cm¬≤', 25, yPos);
                yPos += 10;
                
                pdf.text('üëê Superficies Vivas (Manos):', 20, yPos);
                yPos += 6;
                pdf.text('  ‚Ä¢ Mes√≥filos Aerobios: ‚â§ 3,000 UFC/cm¬≤', 25, yPos);
                yPos += 5;
                pdf.text('  ‚Ä¢ Coliformes Totales: ‚â§ 10 UFC/cm¬≤', 25, yPos);
                yPos += 5;
                pdf.text('  ‚Ä¢ S. Aureus: 0 UFC/cm¬≤ (No detectable)', 25, yPos);
                yPos += 10;
                
                pdf.text('üå°Ô∏è Ambiental:', 20, yPos);
                yPos += 6;
                pdf.text('  ‚Ä¢ Mes√≥filos Aerobios: ‚â§ 200 UFC/cm¬≥', 25, yPos);
                yPos += 5;
                pdf.text('  ‚Ä¢ Mohos: ‚â§ 100 UFC/cm¬≥', 25, yPos);
                yPos += 5;
                pdf.text('  ‚Ä¢ Listeria: 0 UFC/cm¬≥ (No detectable)', 25, yPos);
                
                // Guardar el PDF
                pdf.save('Dashboard_Microbiologico_2025_Completo.pdf');
                
                // Restaurar texto del bot√≥n
                document.querySelector('button[onclick="exportToPDF()"]').textContent = originalText;
                
                alert('‚úÖ PDF completo generado exitosamente con todos los datos y secciones');
                
            } catch (error) {
                alert('‚ùå Error al generar el PDF: ' + error.message);
                document.querySelector('button[onclick="exportToPDF()"]').textContent = originalText;
            }
        }

        // Funci√≥n para imprimir p√°gina completa
        function printFullReport() {
            // Guardar estado actual
            const currentTab = document.querySelector('.tab-active').id;
            
            // Crear ventana de impresi√≥n con todos los datos
            const printWindow = window.open('', '_blank');
            const printContent = generatePrintableContent();
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Dashboard Microbiol√≥gico 2025 - Reporte Completo</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .section { margin-bottom: 40px; page-break-inside: avoid; }
                        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
                        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .data-table th { background-color: #f5f5f5; font-weight: bold; }
                        .compliant { background-color: #d4edda; }
                        .non-compliant { background-color: #f8d7da; }
                        .page-break { page-break-before: always; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 1000);
        }

        // Generar contenido imprimible
        function generatePrintableContent() {
            const now = new Date().toLocaleDateString('es-ES');
            let content = `
                <div class="header">
                    <h1>üß™ Dashboard Microbiol√≥gico 2025</h1>
                    <p>Reporte Completo - Generado el ${now}</p>
                </div>
            `;
            
            // Resumen General
            content += `
                <div class="section">
                    <h2 class="section-title">üìä Resumen General</h2>
                    <p><strong>Cumplimiento General:</strong> ${document.getElementById('cumplimiento-porcentaje').textContent}</p>
                    <p><strong>Total de Muestras:</strong> ${document.getElementById('total-muestras').textContent}</p>
                    <p><strong>No Conformidades:</strong> ${document.getElementById('no-conformidades').textContent}</p>
                    <p><strong>Acciones Correctivas:</strong> ${document.getElementById('acciones-correctivas').textContent}</p>
                </div>
            `;
            
            // Producto en Proceso
            content += generateSectionTable('üè≠ Producto en Proceso', currentData.productoEnProceso);
            
            // Superficies Inertes
            content += generateInertesTable();
            
            // Superficies Vivas
            content += generateVivasTable();
            
            // Ambiental
            content += generateAmbientalTable();
            
            // Plan de Acci√≥n
            content += generateAccionesTable();
            
            return content;
        }

        // Generar tabla de secci√≥n
        function generateSectionTable(title, data) {
            let content = `<div class="section page-break"><h2 class="section-title">${title}</h2>`;
            
            if (title.includes('Producto')) {
                content += `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th>Mes√≥filos Aerobios (UFC/g)</th>
                                <th>Coliformes Totales (UFC/g)</th>
                                <th>E. coli (UFC/g)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.meses.forEach((mes, index) => {
                    const mesofilos = data.mesofilosAerobios.resultados[index];
                    const coliformes = data.coliformesTotales.resultados[index];
                    const ecoli = data.eColi.resultados[index];
                    
                    content += `
                        <tr>
                            <td>${mes}</td>
                            <td class="${mesofilos <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${mesofilos}</td>
                            <td class="${coliformes <= data.coliformesTotales.limite ? 'compliant' : 'non-compliant'}">${coliformes}</td>
                            <td class="${ecoli <= data.eColi.limite ? 'compliant' : 'non-compliant'}">${ecoli}</td>
                        </tr>
                    `;
                });
                
                content += `</tbody></table>`;
                content += `<p><strong>L√≠mites:</strong> Mes√≥filos ‚â§${data.mesofilosAerobios.limite}, Coliformes ‚â§${data.coliformesTotales.limite}, E.coli ‚â§${data.eColi.limite}</p>`;
            }
            
            content += `</div>`;
            return content;
        }

        function generateInertesTable() {
            const data = currentData.superficiesInertes;
            let content = `<div class="section page-break"><h2 class="section-title">üßΩ Superficies Inertes</h2>`;
            
            content += `<table class="data-table"><thead><tr><th>Mes</th><th>Par√°metro</th><th>R1</th><th>R2</th><th>R3</th><th>R4</th></tr></thead><tbody>`;
            
            data.meses.forEach((mes, index) => {
                content += `
                    <tr>
                        <td rowspan="2">${mes}</td>
                        <td>Mes√≥filos Aerobios</td>
                        <td class="${data.mesofilosAerobios.resultado1[index] <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${data.mesofilosAerobios.resultado1[index]}</td>
                        <td class="${data.mesofilosAerobios.resultado2[index] <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${data.mesofilosAerobios.resultado2[index]}</td>
                        <td class="${data.mesofilosAerobios.resultado3[index] <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${data.mesofilosAerobios.resultado3[index]}</td>
                        <td class="${data.mesofilosAerobios.resultado4[index] <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${data.mesofilosAerobios.resultado4[index]}</td>
                    </tr>
                    <tr>
                        <td>Coliformes Totales</td>
                        <td class="${data.coliformesTotales.resultado1[index] <= data.coliformesTotales.limite ? 'compliant' : 'non-compliant'}">${data.coliformesTotales.resultado1[index]}</td>
                        <td class="${data.coliformesTotales.resultado2[index] <= data.coliformesTotales.limite ? 'compliant' : 'non-compliant'}">${data.coliformesTotales.resultado2[index]}</td>
                        <td class="${data.coliformesTotales.resultado3[index] <= data.coliformesTotales.limite ? 'compliant' : 'non-compliant'}">${data.coliformesTotales.resultado3[index]}</td>
                        <td class="${data.coliformesTotales.resultado4[index] <= data.coliformesTotales.limite ? 'compliant' : 'non-compliant'}">${data.coliformesTotales.resultado4[index]}</td>
                    </tr>
                `;
            });
            
            content += `</tbody></table>`;
            content += `<p><strong>L√≠mites:</strong> Mes√≥filos ‚â§${data.mesofilosAerobios.limite} UFC/cm¬≤, Coliformes ‚â§${data.coliformesTotales.limite} UFC/cm¬≤</p></div>`;
            return content;
        }

        function generateVivasTable() {
            const data = currentData.superficiesVivas;
            let content = `<div class="section page-break"><h2 class="section-title">üëê Superficies Vivas (Manos)</h2>`;
            
            content += `<table class="data-table"><thead><tr><th>Mes</th><th>Par√°metro</th><th>Manos en Proceso</th><th>Manos Lavadas</th></tr></thead><tbody>`;
            
            data.meses.forEach((mes, index) => {
                content += `
                    <tr>
                        <td rowspan="3">${mes}</td>
                        <td>Mes√≥filos Aerobios</td>
                        <td class="${data.mesofilosAerobios.manosEnProceso[index] <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${data.mesofilosAerobios.manosEnProceso[index]}</td>
                        <td class="${data.mesofilosAerobios.manosLavadas[index] <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${data.mesofilosAerobios.manosLavadas[index]}</td>
                    </tr>
                    <tr>
                        <td>Coliformes Totales</td>
                        <td class="${data.coliformesTotales.manosEnProceso[index] <= data.coliformesTotales.limite ? 'compliant' : 'non-compliant'}">${data.coliformesTotales.manosEnProceso[index]}</td>
                        <td class="${data.coliformesTotales.manosLavadas[index] <= data.coliformesTotales.limite ? 'compliant' : 'non-compliant'}">${data.coliformesTotales.manosLavadas[index]}</td>
                    </tr>
                    <tr>
                        <td>S. Aureus</td>
                        <td class="${data.sAureus.manosEnProceso[index] <= data.sAureus.limite ? 'compliant' : 'non-compliant'}">${data.sAureus.manosEnProceso[index]}</td>
                        <td class="${data.sAureus.manosLavadas[index] <= data.sAureus.limite ? 'compliant' : 'non-compliant'}">${data.sAureus.manosLavadas[index]}</td>
                    </tr>
                `;
            });
            
            content += `</tbody></table>`;
            content += `<p><strong>L√≠mites:</strong> Mes√≥filos ‚â§${data.mesofilosAerobios.limite} UFC/cm¬≤, Coliformes ‚â§${data.coliformesTotales.limite} UFC/cm¬≤, S.Aureus ‚â§${data.sAureus.limite} UFC/cm¬≤</p></div>`;
            return content;
        }

        function generateAmbientalTable() {
            const data = currentData.ambiental;
            let content = `<div class="section page-break"><h2 class="section-title">üå°Ô∏è An√°lisis Ambiental</h2>`;
            
            content += `<table class="data-table"><thead><tr><th>Mes</th><th>Mes√≥filos Aerobios</th><th>Mohos</th><th>Listeria</th></tr></thead><tbody>`;
            
            data.meses.forEach((mes, index) => {
                content += `
                    <tr>
                        <td>${mes}</td>
                        <td class="${data.mesofilosAerobios.resultados[index] <= data.mesofilosAerobios.limite ? 'compliant' : 'non-compliant'}">${data.mesofilosAerobios.resultados[index]}</td>
                        <td class="${data.mohos.resultados[index] <= data.mohos.limite ? 'compliant' : 'non-compliant'}">${data.mohos.resultados[index]}</td>
                        <td class="${data.listeria.resultados[index] <= data.listeria.limite ? 'compliant' : 'non-compliant'}">${data.listeria.resultados[index]}</td>
                    </tr>
                `;
            });
            
            content += `</tbody></table>`;
            content += `<p><strong>L√≠mites:</strong> Mes√≥filos ‚â§${data.mesofilosAerobios.limite} UFC/cm¬≥, Mohos ‚â§${data.mohos.limite} UFC/cm¬≥, Listeria ‚â§${data.listeria.limite} UFC/cm¬≥</p></div>`;
            return content;
        }

        function generateAccionesTable() {
            let content = `<div class="section page-break"><h2 class="section-title">‚ö†Ô∏è Plan de Acci√≥n Correctiva</h2>`;
            
            if (currentData.planAccion && currentData.planAccion.length > 0) {
                content += `<table class="data-table"><thead><tr><th>Fecha</th><th>Muestreo</th><th>Resultado</th><th>Acci√≥n Correctiva</th><th>Responsable</th><th>Estado</th></tr></thead><tbody>`;
                
                currentData.planAccion.forEach(accion => {
                    content += `
                        <tr>
                            <td>${accion.fecha}</td>
                            <td>${accion.muestreo}</td>
                            <td>${accion.resultado}</td>
                            <td>${accion.accionCorrectiva}</td>
                            <td>${accion.responsable}</td>
                            <td class="${accion.estado === 'Cerrada' ? 'compliant' : 'non-compliant'}">${accion.estado}</td>
                        </tr>
                    `;
                });
                
                content += `</tbody></table>`;
            } else {
                content += `<p>No hay acciones correctivas registradas.</p>`;
            }
            
            content += `</div>`;
            return content;
        }

        // Funci√≥n para inicializar formularios del editor
        function initializeEditorForms() {
            generateProductoForm();
            generateInertesForm();
            generateVivasForm();
            generateAmbientalForm();
            generateAccionesForm();
        }

        // Generar formulario de Producto en Proceso
        function generateProductoForm() {
            const container = document.getElementById('productoForm');
            const data = currentData.productoEnProceso;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/g)
                        </label>
                        <input type="number" id="producto-mesofilos-${index}" 
                               value="${data.mesofilosAerobios.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üß™ Coliformes Totales (L√≠mite: ${data.coliformesTotales.limite.toLocaleString()} UFC/g)
                        </label>
                        <input type="number" id="producto-coliformes-${index}" 
                               value="${data.coliformesTotales.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.coliformesTotales.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‚ö†Ô∏è E. coli (L√≠mite: ${data.eColi.limite.toLocaleString()} UFC/g)
                        </label>
                        <input type="number" id="producto-ecoli-${index}" 
                               value="${data.eColi.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.eColi.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        // Generar formulario de Superficies Inertes
        function generateInertesForm() {
            const container = document.getElementById('inertesForm');
            const data = currentData.superficiesInertes;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                
                let mesofilosInputs = '';
                let coliformesInputs = '';
                
                for (let i = 1; i <= 4; i++) {
                    mesofilosInputs += `
                        <div class="mb-2">
                            <label class="block text-xs text-gray-600 mb-1">Resultado ${i}</label>
                            <input type="number" id="inertes-mesofilos-${i}-${index}" 
                                   value="${data.mesofilosAerobios[`resultado${i}`][index]}" 
                                   class="form-input w-full text-sm" 
                                   onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                                   placeholder="UFC/cm¬≤">
                        </div>
                    `;
                    
                    coliformesInputs += `
                        <div class="mb-2">
                            <label class="block text-xs text-gray-600 mb-1">Resultado ${i}</label>
                            <input type="number" id="inertes-coliformes-${i}-${index}" 
                                   value="${data.coliformesTotales[`resultado${i}`][index]}" 
                                   class="form-input w-full text-sm" 
                                   onchange="validateInput(this, ${data.coliformesTotales.limite})"
                                   placeholder="UFC/cm¬≤">
                        </div>
                    `;
                }
                
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        ${mesofilosInputs}
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            üß™ Coliformes Totales (L√≠mite: ${data.coliformesTotales.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        ${coliformesInputs}
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        // Generar formulario de Superficies Vivas
        function generateVivasForm() {
            const container = document.getElementById('vivasForm');
            const data = currentData.superficiesVivas;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos en Proceso</label>
                                <input type="number" id="vivas-mesofilos-proceso-${index}" 
                                       value="${data.mesofilosAerobios.manosEnProceso[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos Lavadas</label>
                                <input type="number" id="vivas-mesofilos-lavadas-${index}" 
                                       value="${data.mesofilosAerobios.manosLavadas[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                        </div>
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            üß™ Coliformes Totales (L√≠mite: ${data.coliformesTotales.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos en Proceso</label>
                                <input type="number" id="vivas-coliformes-proceso-${index}" 
                                       value="${data.coliformesTotales.manosEnProceso[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.coliformesTotales.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos Lavadas</label>
                                <input type="number" id="vivas-coliformes-lavadas-${index}" 
                                       value="${data.coliformesTotales.manosLavadas[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.coliformesTotales.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                        </div>
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ‚ö†Ô∏è S. Aureus (L√≠mite: ${data.sAureus.limite} UFC/cm¬≤)
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos en Proceso</label>
                                <input type="number" id="vivas-aureus-proceso-${index}" 
                                       value="${data.sAureus.manosEnProceso[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.sAureus.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos Lavadas</label>
                                <input type="number" id="vivas-aureus-lavadas-${index}" 
                                       value="${data.sAureus.manosLavadas[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.sAureus.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        // Generar formulario Ambiental
        function generateAmbientalForm() {
            const container = document.getElementById('ambientalForm');
            const data = currentData.ambiental;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/cm¬≥)
                        </label>
                        <input type="number" id="ambiental-mesofilos-${index}" 
                               value="${data.mesofilosAerobios.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üçÑ Mohos (L√≠mite: ${data.mohos.limite.toLocaleString()} UFC/cm¬≥)
                        </label>
                        <input type="number" id="ambiental-mohos-${index}" 
                               value="${data.mohos.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.mohos.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‚ö†Ô∏è Listeria (L√≠mite: ${data.listeria.limite} UFC/cm¬≥)
                        </label>
                        <input type="number" id="ambiental-listeria-${index}" 
                               value="${data.listeria.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.listeria.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        // Generar formulario de Plan de Acci√≥n
        function generateAccionesForm() {
            const container = document.getElementById('accionesForm');
            container.innerHTML = '';
            
            currentData.planAccion.forEach((accion, index) => {
                addActionCard(container, accion, index);
            });
        }

        // Agregar tarjeta de acci√≥n
        function addActionCard(container, accion, index) {
            const actionCard = document.createElement('div');
            actionCard.className = 'action-card';
            actionCard.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">Acci√≥n Correctiva #${index + 1}</h4>
                    <button onclick="removeAction(${index})" class="text-red-600 hover:text-red-800 font-medium">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Fecha de Muestreo</label>
                        <input type="date" id="accion-fecha-${index}" 
                               value="${accion.fecha}" 
                               class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üî¨ Tipo de Muestreo</label>
                        <select id="accion-muestreo-${index}" class="form-input w-full">
                            <option value="PP" ${accion.muestreo === 'PP' ? 'selected' : ''}>PP - Producto en Proceso</option>
                            <option value="SI" ${accion.muestreo === 'SI' ? 'selected' : ''}>SI - Superficies Inertes</option>
                            <option value="SV" ${accion.muestreo === 'SV' ? 'selected' : ''}>SV - Superficies Vivas</option>
                            <option value="AM" ${accion.muestreo === 'AM' ? 'selected' : ''}>AM - Ambiental</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìä Resultado</label>
                        <textarea id="accion-resultado-${index}" 
                                  class="form-input w-full h-20 resize-none" 
                                  placeholder="Ej: Mes√≥filos aerobios: 450 UFC/cm¬≤ (L√≠mite: 400)">${accion.resultado}</textarea>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">üîß Acci√≥n Correctiva</label>
                        <textarea id="accion-correctiva-${index}" 
                                  class="form-input w-full h-20 resize-none" 
                                  placeholder="Describa la acci√≥n correctiva tomada">${accion.accionCorrectiva}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üë§ Responsable</label>
                        <input type="text" id="accion-responsable-${index}" 
                               value="${accion.responsable}" 
                               class="form-input w-full" 
                               placeholder="Nombre del responsable">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‚úÖ Fecha de Cierre</label>
                        <input type="date" id="accion-cierre-${index}" 
                               value="${accion.fechaCierre}" 
                               class="form-input w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">üìã Estado</label>
                        <select id="accion-estado-${index}" class="form-input w-full">
                            <option value="Abierta" ${accion.estado === 'Abierta' ? 'selected' : ''}>Abierta</option>
                            <option value="En Proceso" ${accion.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                            <option value="Cerrada" ${accion.estado === 'Cerrada' ? 'selected' : ''}>Cerrada</option>
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(actionCard);
        }

        // Agregar nueva acci√≥n
        function addNewAction() {
            const newAction = {
                fecha: new Date().toISOString().split('T')[0],
                muestreo: 'PP',
                resultado: '',
                accionCorrectiva: '',
                responsable: '',
                fechaCierre: '',
                estado: 'Abierta'
            };
            
            currentData.planAccion.push(newAction);
            const container = document.getElementById('accionesForm');
            addActionCard(container, newAction, currentData.planAccion.length - 1);
        }

        // Eliminar acci√≥n
        function removeAction(index) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta acci√≥n correctiva?')) {
                currentData.planAccion.splice(index, 1);
                generateAccionesForm();
            }
        }

        // Validar entrada de datos
        function validateInput(input, limit) {
            const value = parseFloat(input.value) || 0;
            
            input.classList.remove('error', 'success');
            
            if (value <= limit) {
                input.classList.add('success');
            } else {
                input.classList.add('error');
            }
            
            // Auto-guardar despu√©s de 2 segundos de inactividad
            clearTimeout(input.autoSaveTimeout);
            input.autoSaveTimeout = setTimeout(() => {
                autoSaveData();
            }, 2000);
        }

        // Recopilar datos del plan de acci√≥n
        function collectActionData() {
            currentData.planAccion.forEach((accion, index) => {
                const fecha = document.getElementById(`accion-fecha-${index}`)?.value;
                const muestreo = document.getElementById(`accion-muestreo-${index}`)?.value;
                const resultado = document.getElementById(`accion-resultado-${index}`)?.value;
                const correctiva = document.getElementById(`accion-correctiva-${index}`)?.value;
                const responsable = document.getElementById(`accion-responsable-${index}`)?.value;
                const cierre = document.getElementById(`accion-cierre-${index}`)?.value;
                const estado = document.getElementById(`accion-estado-${index}`)?.value;
                
                if (fecha !== undefined) accion.fecha = fecha;
                if (muestreo !== undefined) accion.muestreo = muestreo;
                if (resultado !== undefined) accion.resultado = resultado;
                if (correctiva !== undefined) accion.accionCorrectiva = correctiva;
                if (responsable !== undefined) accion.responsable = responsable;
                if (cierre !== undefined) accion.fechaCierre = cierre;
                if (estado !== undefined) accion.estado = estado;
            });
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos guardados si existen
            loadSavedData();
            
            // Mostrar fecha actual si no hay fecha guardada
            if (!localStorage.getItem('lastUpdate')) {
                document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('es-ES');
            }
            
            // Cargar datos en el editor
            document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
            
            // Inicializar con la primera pesta√±a
            showTab('resumen');
            
            // Mostrar mensaje de bienvenida si es la primera vez
            if (!localStorage.getItem('microbiologicalData')) {
                setTimeout(() => {
                    alert('üëã ¬°Bienvenido al Dashboard Microbiol√≥gico!\n\n‚ú® Caracter√≠sticas principales:\n‚Ä¢ Los datos se guardan autom√°ticamente\n‚Ä¢ Puedes exportar reportes completos en PDF\n‚Ä¢ La informaci√≥n se mantiene al compartir la p√°gina\n‚Ä¢ Usa el "Editor de Datos" para modificar valores\n\nüí° Tip: Todos los cambios se guardan permanentemente en tu navegador.');
                }, 1000);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9786f8ff7505ceb7',t:'MTc1Njc1MjgyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
