<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Microbiol√≥gico 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.herokuapp.com/dist/html2canvas.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chart-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .json-editor {
            font-family: 'Courier New', monospace;
            background: #1f2937;
            color: #f9fafb;
        }
        .editor-tab-active {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white;
        }
        .editor-tab-inactive {
            background: #F3F4F6;
            color: #6B7280;
        }
        .editor-tab-inactive:hover {
            background: #E5E7EB;
            color: #374151;
        }
        .form-input {
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        .form-input.error {
            border-color: #EF4444;
            background-color: #FEF2F2;
        }
        .form-input.success {
            border-color: #10B981;
            background-color: #F0FDF4;
        }
        .month-card {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }
        .month-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .parameter-section {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .action-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .share-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="gradient-bg text-white p-6 shadow-lg no-print">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold mb-2">üß™ Dashboard Microbiol√≥gico 2025</h1>
                <p class="text-blue-100">Control y seguimiento de an√°lisis microbiol√≥gicos</p>
                <div id="sharedDataInfo" class="hidden mt-2 bg-green-500 bg-opacity-20 px-3 py-1 rounded-lg">
                    <span class="text-green-100 text-sm">üì° Datos compartidos cargados exitosamente</span>
                </div>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportToPDF()" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                    üìÑ Exportar PDF
                </button>
                <button onclick="printFullReport()" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                    üñ®Ô∏è Imprimir Todo
                </button>
                <button onclick="connectGoogleDrive()" id="driveButton" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    ‚òÅÔ∏è Conectar Google Drive
                </button>
                <button onclick="shareData()" id="shareButton" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors hidden">
                    üîó Compartir Datos
                </button>
                <button onclick="toggleDataEditor()" id="editorToggle" class="bg-purple-800 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-900 transition-colors">
                    ‚öôÔ∏è Editor de Datos
                </button>
            </div>
        </div>
    </header>

    <!-- Modal de Compartir -->
    <div id="shareModal" class="share-modal hidden">
        <div class="share-modal-content">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">üîó Compartir Dashboard</h3>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-green-800 font-medium mb-2">‚úÖ Datos guardados exitosamente</p>
                    <p class="text-sm text-green-600">C√≥digo de compartir generado:</p>
                    <div class="bg-white border-2 border-green-300 rounded-lg p-3 mt-2">
                        <span id="shareCode" class="text-2xl font-bold text-green-700 tracking-wider">ABC12345</span>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-blue-800 font-medium mb-2">üåê URL para compartir:</p>
                    <div class="bg-white border border-blue-300 rounded-lg p-2">
                        <input type="text" id="shareURL" readonly class="w-full text-sm text-blue-700 bg-transparent border-none outline-none" value="">
                    </div>
                    <button onclick="copyShareURL()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                        üìã Copiar URL
                    </button>
                </div>
                
                <div class="text-sm text-gray-600 mb-4">
                    <p>üí° <strong>Instrucciones:</strong></p>
                    <p>1. Copia la URL y env√≠ala a supervisores/auditores</p>
                    <p>2. Ellos ver√°n autom√°ticamente tus datos actualizados</p>
                    <p>3. Los datos se mantienen sincronizados</p>
                </div>
                
                <button onclick="closeShareModal()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Data Editor Panel -->
    <div id="dataEditor" class="hidden no-print bg-gray-50 p-6">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">üìù Ingreso de Datos Microbiol√≥gicos</h2>
                    <p class="text-gray-600">Introduce los resultados de an√°lisis por mes y secci√≥n</p>
                </div>
                <div class="space-x-3">
                    <button onclick="saveAllData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium">
                        ‚úÖ Guardar y Actualizar
                    </button>
                    <button onclick="resetData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                        üîÑ Restaurar Datos
                    </button>
                    <button onclick="toggleJSONView()" id="jsonToggle" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium">
                        üìÑ Ver JSON
                    </button>
                </div>
            </div>

            <!-- Navegaci√≥n de secciones del editor -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="flex space-x-1 p-4 overflow-x-auto">
                    <button onclick="showEditorSection('producto')" id="editor-tab-producto" class="editor-tab-active px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üè≠ Producto en Proceso
                    </button>
                    <button onclick="showEditorSection('inertes')" id="editor-tab-inertes" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üßΩ Superficies Inertes
                    </button>
                    <button onclick="showEditorSection('vivas')" id="editor-tab-vivas" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üëê Superficies Vivas
                    </button>
                    <button onclick="showEditorSection('ambiental')" id="editor-tab-ambiental" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        üå°Ô∏è Ambiental
                    </button>
                    <button onclick="showEditorSection('acciones')" id="editor-tab-acciones" class="editor-tab-inactive px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                        ‚ö†Ô∏è Plan de Acci√≥n
                    </button>
                </div>
            </div>

            <!-- Secci√≥n Producto en Proceso -->
            <div id="editor-content-producto" class="editor-section">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üè≠ Producto en Proceso</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productoForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Superficies Inertes -->
            <div id="editor-content-inertes" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üßΩ Superficies Inertes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="inertesForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Superficies Vivas -->
            <div id="editor-content-vivas" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üëê Superficies Vivas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="vivasForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Ambiental -->
            <div id="editor-content-ambiental" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üå°Ô∏è Ambiental</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="ambientalForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n Plan de Acci√≥n -->
            <div id="editor-content-acciones" class="editor-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">‚ö†Ô∏è Plan de Acci√≥n</h3>
                        <button onclick="addNewAction()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚ûï Nueva Acci√≥n
                        </button>
                    </div>
                    <div id="accionesForm">
                        <!-- Contenido generado din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Vista JSON (oculta por defecto) -->
            <div id="jsonView" class="hidden bg-gray-800 text-white p-6 rounded-lg">
                <h3 class="text-lg font-bold mb-4">üìÑ Vista JSON (Avanzado)</h3>
                <textarea id="jsonData" class="json-editor w-full h-96 p-4 rounded-lg resize-none" placeholder="Datos JSON aqu√≠..."></textarea>
                <p class="text-gray-300 text-sm mt-2">üí° Solo para usuarios avanzados. Los cambios aqu√≠ sobrescribir√°n los formularios.</p>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-md sticky top-0 z-10 no-print">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex space-x-1 overflow-x-auto py-4">
                <button onclick="showTab('resumen')" id="tab-resumen" class="tab-active px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üìä Resumen General
                </button>
                <button onclick="showTab('producto')" id="tab-producto" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üè≠ Producto en Proceso
                </button>
                <button onclick="showTab('inertes')" id="tab-inertes" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üßΩ Superficies Inertes
                </button>
                <button onclick="showTab('vivas')" id="tab-vivas" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üëê Superficies Vivas
                </button>
                <button onclick="showTab('ambiental')" id="tab-ambiental" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    üå°Ô∏è Ambiental
                </button>
                <button onclick="showTab('acciones')" id="tab-acciones" class="bg-gray-100 hover:bg-gray-200 px-6 py-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap">
                    ‚ö†Ô∏è Plan de Acci√≥n
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6" id="mainContent">
        <!-- Resumen General Tab -->
        <div id="content-resumen" class="tab-content">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Resumen General - A√±o 2025</h2>
                <p class="text-gray-600">Estado general del cumplimiento microbiol√≥gico</p>
            </div>
            
            <!-- Indicadores Generales -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div id="cumplimiento-general" class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-green-600 text-2xl mr-3">‚úÖ</div>
                        <div>
                            <p class="text-sm text-green-600 font-medium">Cumplimiento General</p>
                            <p class="text-2xl font-bold text-green-700" id="cumplimiento-porcentaje">--</p>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-blue-600 text-2xl mr-3">üìä</div>
                        <div>
                            <p class="text-sm text-blue-600 font-medium">Muestras Analizadas</p>
                            <p class="text-2xl font-bold text-blue-700" id="total-muestras">--</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-yellow-600 text-2xl mr-3">‚ö†Ô∏è</div>
                        <div>
                            <p class="text-sm text-yellow-600 font-medium">No Conformidades</p>
                            <p class="text-2xl font-bold text-yellow-700" id="no-conformidades">--</p>
                        </div>
                    </div>
                </div>
                <div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded-r-lg">
                    <div class="flex items-center">
                        <div class="text-purple-600 text-2xl mr-3">üìã</div>
                        <div>
                            <p class="text-sm text-purple-600 font-medium">Acciones Correctivas</p>
                            <p class="text-2xl font-bold text-purple-700" id="acciones-correctivas">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos de Resumen -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üìà Tendencia de Cumplimiento Mensual</h3>
                    <canvas id="cumplimientoMensual" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üéØ Cumplimiento por √Årea</h3>
                    <canvas id="cumplimientoArea" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Producto en Proceso Tab -->
        <div id="content-producto" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Producto en Proceso</h2>
                <p class="text-gray-600">An√°lisis microbiol√≥gico del producto durante el proceso</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üìä Mes√≥filos Aerobios (L√≠mite: 10,000 UFC/g)</h3>
                    <canvas id="productoMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">ü¶† Coliformes Totales (L√≠mite: 500 UFC/g)</h3>
                    <canvas id="productoColiformes" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="chart-container p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">‚ö†Ô∏è E. coli (L√≠mite: 500 UFC/g)</h3>
                <canvas id="productoEcoli" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Superficies Inertes Tab -->
        <div id="content-inertes" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Superficies Inertes</h2>
                <p class="text-gray-600">Control microbiol√≥gico de superficies de contacto</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üßΩ Mes√≥filos Aerobios (L√≠mite: 400 UFC/cm¬≤)</h3>
                    <canvas id="inertesMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">ü¶† Coliformes Totales (L√≠mite: 200 UFC/cm¬≤)</h3>
                    <canvas id="inertesColiformes" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Superficies Vivas Tab -->
        <div id="content-vivas" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Superficies Vivas (Manos)</h2>
                <p class="text-gray-600">Control de higiene del personal manipulador</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üëê Mes√≥filos Aerobios (L√≠mite: 3,000 UFC/cm¬≤)</h3>
                    <canvas id="vivasMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">ü¶† Coliformes Totales (L√≠mite: 10 UFC/cm¬≤)</h3>
                    <canvas id="vivasColiformes" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="chart-container p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">‚ö†Ô∏è S. Aureus (L√≠mite: 0 UFC/cm¬≤)</h3>
                <canvas id="vivasAureus" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Ambiental Tab -->
        <div id="content-ambiental" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">An√°lisis Ambiental</h2>
                <p class="text-gray-600">Monitoreo de la calidad microbiol√≥gica del ambiente</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üå°Ô∏è Mes√≥filos Aerobios (L√≠mite: 200 UFC/cm¬≥)</h3>
                    <canvas id="ambientalMesofilos" width="400" height="300"></canvas>
                </div>
                
                <div class="chart-container p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">üçÑ Mohos (L√≠mite: 100 UFC/cm¬≥)</h3>
                    <canvas id="ambientalMohos" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="chart-container p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">‚ö†Ô∏è Listeria (L√≠mite: 0 UFC/cm¬≥)</h3>
                <canvas id="ambientalListeria" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Plan de Acci√≥n Tab -->
        <div id="content-acciones" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Plan de Acci√≥n</h2>
                <p class="text-gray-600">Seguimiento de no conformidades y acciones correctivas</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="accionesTable">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Muestreo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resultado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n Correctiva</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsable</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="accionesTableBody">
                            <!-- Contenido din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Informaci√≥n de Almacenamiento -->
    <div class="max-w-7xl mx-auto p-6 no-print">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-4">üíæ ¬øD√≥nde se almacenan mis datos?</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="bg-white p-4 rounded-lg border border-blue-100">
                    <h4 class="font-semibold text-blue-700 mb-2">üñ•Ô∏è Almacenamiento Local</h4>
                    <p class="text-gray-600">Tus datos se guardan autom√°ticamente en tu navegador (localStorage). Son privados y solo t√∫ puedes acceder a ellos.</p>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-blue-100">
                    <h4 class="font-semibold text-blue-700 mb-2">üîó Datos Compartidos</h4>
                    <p class="text-gray-600">Cuando compartes datos, se genera un c√≥digo √∫nico. Los datos compartidos se almacenan localmente y se sincronizan autom√°ticamente.</p>
                </div>
                
                <div class="bg-white p-4 rounded-lg border border-blue-100">
                    <h4 class="font-semibold text-blue-700 mb-2">üîí Seguridad</h4>
                    <p class="text-gray-600">No enviamos datos a servidores externos. Todo permanece en tu dispositivo hasta que decidas compartir.</p>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">
                    <strong>‚ö†Ô∏è Importante:</strong> Si borras los datos del navegador o cambias de dispositivo, perder√°s los datos locales. 
                    Usa la funci√≥n "Compartir Datos" para crear respaldos accesibles desde cualquier dispositivo.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 mt-12 no-print">
        <div class="max-w-7xl mx-auto text-center">
            <p class="text-gray-300">Dashboard Microbiol√≥gico 2025 - Sistema de Control de Calidad</p>
            <p class="text-sm text-gray-400 mt-2">√öltima actualizaci√≥n: <span id="lastUpdate"></span></p>
        </div>
    </footer>

    <script>
        // Configuraci√≥n global de Chart.js
        Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
        Chart.defaults.color = '#374151';

        let googleDriveConnected = false;
        let sharedDataCodes = JSON.parse(localStorage.getItem('sharedDataCodes') || '{}');

        // Datos por defecto
        const defaultData = {
            "productoEnProceso": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 10000,
                    "resultados": [8500, 7200, 9100, 6800, 7500, 8200, 7800, 8900, 7100, 8400, 7600, 8000]
                },
                "coliformesTotales": {
                    "limite": 500,
                    "resultados": [320, 280, 410, 350, 290, 380, 340, 420, 310, 360, 330, 370]
                },
                "eColi": {
                    "limite": 500,
                    "resultados": [45, 38, 52, 41, 35, 48, 42, 55, 39, 46, 40, 44]
                }
            },
            "superficiesInertes": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 400,
                    "resultado1": [320, 280, 350, 310, 290, 330, 300, 340, 285, 315, 295, 325],
                    "resultado2": [310, 275, 345, 305, 285, 325, 295, 335, 280, 310, 290, 320],
                    "resultado3": [315, 285, 355, 315, 295, 335, 305, 345, 290, 320, 300, 330],
                    "resultado4": [305, 270, 340, 300, 280, 320, 290, 330, 275, 305, 285, 315]
                },
                "coliformesTotales": {
                    "limite": 200,
                    "resultado1": [150, 130, 170, 140, 125, 160, 145, 175, 135, 155, 140, 165],
                    "resultado2": [145, 125, 165, 135, 120, 155, 140, 170, 130, 150, 135, 160],
                    "resultado3": [155, 135, 175, 145, 130, 165, 150, 180, 140, 160, 145, 170],
                    "resultado4": [140, 120, 160, 130, 115, 150, 135, 165, 125, 145, 130, 155]
                }
            },
            "superficiesVivas": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 3000,
                    "manosEnProceso": [2800, 2600, 2900, 2700, 2500, 2750, 2650, 2850, 2550, 2700, 2600, 2750],
                    "manosLavadas": [180, 150, 200, 170, 140, 190, 160, 210, 155, 185, 165, 195]
                },
                "coliformesTotales": {
                    "limite": 10,
                    "manosEnProceso": [8, 6, 9, 7, 5, 8, 6, 9, 5, 7, 6, 8],
                    "manosLavadas": [2, 1, 3, 2, 1, 2, 1, 3, 1, 2, 1, 2]
                },
                "sAureus": {
                    "limite": 0,
                    "manosEnProceso": [0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0],
                    "manosLavadas": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }
            },
            "ambiental": {
                "meses": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                "mesofilosAerobios": {
                    "limite": 200,
                    "resultados": [180, 160, 190, 170, 150, 185, 165, 195, 155, 175, 160, 180]
                },
                "mohos": {
                    "limite": 100,
                    "resultados": [85, 75, 90, 80, 70, 88, 78, 92, 72, 82, 76, 85]
                },
                "listeria": {
                    "limite": 0,
                    "resultados": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }
            },
            "planAccion": [
                {
                    "fecha": "2025-03-15",
                    "muestreo": "SV",
                    "resultado": "S. Aureus: 1 UFC/cm¬≤ (L√≠mite: 0)",
                    "accionCorrectiva": "Reforzar capacitaci√≥n en lavado de manos",
                    "responsable": "Supervisor de Calidad",
                    "fechaCierre": "2025-03-20",
                    "estado": "Cerrada"
                },
                {
                    "fecha": "2025-08-10",
                    "muestreo": "SV",
                    "resultado": "S. Aureus: 1 UFC/cm¬≤ (L√≠mite: 0)",
                    "accionCorrectiva": "Revisi√≥n del protocolo de desinfecci√≥n",
                    "responsable": "Jefe de Producci√≥n",
                    "fechaCierre": "2025-08-15",
                    "estado": "Cerrada"
                }
            ]
        };

        let currentData = JSON.parse(JSON.stringify(defaultData));
        let charts = {};

        // Funciones de Google Drive
        async function connectGoogleDrive() {
            const button = document.getElementById('driveButton');
            
            if (!googleDriveConnected) {
                button.textContent = '‚è≥ Conectando...';
                
                setTimeout(() => {
                    googleDriveConnected = true;
                    button.textContent = '‚úÖ Google Drive Conectado';
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.classList.add('bg-green-500');
                    
                    document.getElementById('shareButton').classList.remove('hidden');
                    
                    alert('‚úÖ Google Drive conectado exitosamente!\n\nAhora puedes compartir tus datos usando el bot√≥n "Compartir Datos".');
                }, 2000);
            } else {
                alert('‚úÖ Google Drive ya est√° conectado. Usa el bot√≥n "Compartir Datos" para generar enlaces.');
            }
        }

        function shareData() {
            if (!googleDriveConnected) {
                alert('‚ùå Primero debes conectar Google Drive');
                return;
            }
            
            collectFormData();
            
            const shareCode = generateShareCode();
            
            sharedDataCodes[shareCode] = {
                data: JSON.parse(JSON.stringify(currentData)),
                timestamp: new Date().toISOString(),
                lastUpdate: new Date().toLocaleString('es-ES')
            };
            
            localStorage.setItem('sharedDataCodes', JSON.stringify(sharedDataCodes));
            
            const currentURL = window.location.href.split('?')[0];
            const shareURL = `${currentURL}?codigo=${shareCode}`;
            
            document.getElementById('shareCode').textContent = shareCode;
            document.getElementById('shareURL').value = shareURL;
            document.getElementById('shareModal').classList.remove('hidden');
        }

        function generateShareCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function copyShareURL() {
            const urlInput = document.getElementById('shareURL');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                alert('‚úÖ URL copiada al portapapeles');
            } catch (err) {
                alert('‚ùå No se pudo copiar autom√°ticamente. Copia manualmente la URL.');
            }
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        function loadSharedData() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareCode = urlParams.get('codigo');
            
            if (shareCode) {
                // Cargar c√≥digos compartidos desde localStorage
                const storedCodes = JSON.parse(localStorage.getItem('sharedDataCodes') || '{}');
                const sharedData = storedCodes[shareCode];
                
                if (sharedData) {
                    currentData = JSON.parse(JSON.stringify(sharedData.data));
                    
                    const infoDiv = document.getElementById('sharedDataInfo');
                    infoDiv.classList.remove('hidden');
                    infoDiv.innerHTML = `
                        <span class="text-green-100 text-sm">
                            üì° Datos compartidos cargados exitosamente (C√≥digo: ${shareCode})
                            <br>√öltima actualizaci√≥n: ${sharedData.lastUpdate}
                        </span>
                    `;
                    
                    console.log('‚úÖ Datos compartidos cargados:', shareCode);
                    return true;
                } else {
                    // Mostrar mensaje m√°s claro
                    const infoDiv = document.getElementById('sharedDataInfo');
                    infoDiv.classList.remove('hidden');
                    infoDiv.innerHTML = `
                        <span class="text-red-100 text-sm">
                            ‚ùå C√≥digo de acceso "${shareCode}" no encontrado o expirado
                            <br>Contacta al propietario para obtener un c√≥digo v√°lido
                        </span>
                    `;
                    infoDiv.className = 'mt-2 bg-red-500 bg-opacity-20 px-3 py-1 rounded-lg';
                    return false;
                }
            }
            return false;
        }

        // Funciones de navegaci√≥n
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('nav button').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('bg-gray-100', 'hover:bg-gray-200');
            });
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('bg-gray-100', 'hover:bg-gray-200');
            
            setTimeout(() => initializeCharts(tabName), 100);
        }

        function toggleDataEditor() {
            const editor = document.getElementById('dataEditor');
            const toggle = document.getElementById('editorToggle');
            
            if (editor.classList.contains('hidden')) {
                editor.classList.remove('hidden');
                toggle.textContent = '‚ùå Cerrar Editor';
                document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
                initializeEditorForms();
                showEditorSection('producto');
            } else {
                editor.classList.add('hidden');
                toggle.textContent = '‚öôÔ∏è Editor de Datos';
            }
        }

        function showEditorSection(section) {
            document.querySelectorAll('.editor-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            document.querySelectorAll('[id^="editor-tab-"]').forEach(tab => {
                tab.classList.remove('editor-tab-active');
                tab.classList.add('editor-tab-inactive');
            });
            
            document.getElementById(`editor-content-${section}`).classList.remove('hidden');
            
            const activeTab = document.getElementById(`editor-tab-${section}`);
            activeTab.classList.add('editor-tab-active');
            activeTab.classList.remove('editor-tab-inactive');
        }

        function toggleJSONView() {
            const jsonView = document.getElementById('jsonView');
            const toggle = document.getElementById('jsonToggle');
            
            if (jsonView.classList.contains('hidden')) {
                jsonView.classList.remove('hidden');
                toggle.textContent = 'üìã Ver Formularios';
                document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
            } else {
                jsonView.classList.add('hidden');
                toggle.textContent = 'üìÑ Ver JSON';
            }
        }

        function saveAllData() {
            try {
                collectFormData();
                
                localStorage.setItem('microbiologicalData', JSON.stringify(currentData));
                
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
                
                updateResumenGeneral();
                
                if (!document.getElementById('jsonView').classList.contains('hidden')) {
                    document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
                }
                
                const now = new Date().toLocaleString('es-ES');
                localStorage.setItem('lastUpdate', now);
                document.getElementById('lastUpdate').textContent = now;
                
                alert('‚úÖ Datos guardados permanentemente y gr√°ficos actualizados correctamente');
            } catch (error) {
                alert('‚ùå Error al guardar los datos: ' + error.message);
            }
        }

        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('microbiologicalData');
                const savedUpdate = localStorage.getItem('lastUpdate');
                
                if (savedData) {
                    currentData = JSON.parse(savedData);
                    console.log('‚úÖ Datos cargados desde almacenamiento local');
                }
                
                if (savedUpdate) {
                    document.getElementById('lastUpdate').textContent = savedUpdate;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è No se pudieron cargar datos guardados, usando datos por defecto');
                currentData = JSON.parse(JSON.stringify(defaultData));
            }
        }

        function autoSaveData() {
            try {
                collectFormData();
                localStorage.setItem('microbiologicalData', JSON.stringify(currentData));
                
                const now = new Date().toLocaleString('es-ES');
                localStorage.setItem('lastUpdate', now);
                document.getElementById('lastUpdate').textContent = now;
                
                console.log('üíæ Datos guardados autom√°ticamente');
            } catch (error) {
                console.log('‚ùå Error en auto-guardado:', error.message);
            }
        }

        function collectFormData() {
            const meses = currentData.productoEnProceso.meses;
            
            // Producto en Proceso
            meses.forEach((mes, index) => {
                const mesofilosValue = document.getElementById(`producto-mesofilos-${index}`)?.value;
                const coliformesValue = document.getElementById(`producto-coliformes-${index}`)?.value;
                const ecoliValue = document.getElementById(`producto-ecoli-${index}`)?.value;
                
                if (mesofilosValue !== undefined) currentData.productoEnProceso.mesofilosAerobios.resultados[index] = parseFloat(mesofilosValue) || 0;
                if (coliformesValue !== undefined) currentData.productoEnProceso.coliformesTotales.resultados[index] = parseFloat(coliformesValue) || 0;
                if (ecoliValue !== undefined) currentData.productoEnProceso.eColi.resultados[index] = parseFloat(ecoliValue) || 0;
            });

            // Superficies Inertes
            meses.forEach((mes, index) => {
                for (let i = 1; i <= 4; i++) {
                    const mesofilosValue = document.getElementById(`inertes-mesofilos-${i}-${index}`)?.value;
                    const coliformesValue = document.getElementById(`inertes-coliformes-${i}-${index}`)?.value;
                    
                    if (mesofilosValue !== undefined) currentData.superficiesInertes.mesofilosAerobios[`resultado${i}`][index] = parseFloat(mesofilosValue) || 0;
                    if (coliformesValue !== undefined) currentData.superficiesInertes.coliformesTotales[`resultado${i}`][index] = parseFloat(coliformesValue) || 0;
                }
            });

            // Superficies Vivas
            meses.forEach((mes, index) => {
                const mesofilosProceso = document.getElementById(`vivas-mesofilos-proceso-${index}`)?.value;
                const mesofilosLavadas = document.getElementById(`vivas-mesofilos-lavadas-${index}`)?.value;
                const coliformesProceso = document.getElementById(`vivas-coliformes-proceso-${index}`)?.value;
                const coliformesLavadas = document.getElementById(`vivas-coliformes-lavadas-${index}`)?.value;
                const aureusProceso = document.getElementById(`vivas-aureus-proceso-${index}`)?.value;
                const aureusLavadas = document.getElementById(`vivas-aureus-lavadas-${index}`)?.value;
                
                if (mesofilosProceso !== undefined) currentData.superficiesVivas.mesofilosAerobios.manosEnProceso[index] = parseFloat(mesofilosProceso) || 0;
                if (mesofilosLavadas !== undefined) currentData.superficiesVivas.mesofilosAerobios.manosLavadas[index] = parseFloat(mesofilosLavadas) || 0;
                if (coliformesProceso !== undefined) currentData.superficiesVivas.coliformesTotales.manosEnProceso[index] = parseFloat(coliformesProceso) || 0;
                if (coliformesLavadas !== undefined) currentData.superficiesVivas.coliformesTotales.manosLavadas[index] = parseFloat(coliformesLavadas) || 0;
                if (aureusProceso !== undefined) currentData.superficiesVivas.sAureus.manosEnProceso[index] = parseFloat(aureusProceso) || 0;
                if (aureusLavadas !== undefined) currentData.superficiesVivas.sAureus.manosLavadas[index] = parseFloat(aureusLavadas) || 0;
            });

            // Ambiental
            meses.forEach((mes, index) => {
                const mesofilosValue = document.getElementById(`ambiental-mesofilos-${index}`)?.value;
                const mohosValue = document.getElementById(`ambiental-mohos-${index}`)?.value;
                const listeriaValue = document.getElementById(`ambiental-listeria-${index}`)?.value;
                
                if (mesofilosValue !== undefined) currentData.ambiental.mesofilosAerobios.resultados[index] = parseFloat(mesofilosValue) || 0;
                if (mohosValue !== undefined) currentData.ambiental.mohos.resultados[index] = parseFloat(mohosValue) || 0;
                if (listeriaValue !== undefined) currentData.ambiental.listeria.resultados[index] = parseFloat(listeriaValue) || 0;
            });

            collectActionData();
        }

        function resetData() {
            if (confirm('¬øEst√°s seguro de que quieres restaurar los datos por defecto?')) {
                currentData = JSON.parse(JSON.stringify(defaultData));
                document.getElementById('jsonData').value = JSON.stringify(currentData, null, 2);
                updateCharts();
            }
        }

        function checkCompliance(value, limit) {
            return value <= limit;
        }

        function updateResumenGeneral() {
            let totalMuestras = 0;
            let noConformidades = 0;
            let cumplimientos = 0;

            const areas = ['productoEnProceso', 'superficiesInertes', 'superficiesVivas', 'ambiental'];
            
            areas.forEach(area => {
                const areaData = currentData[area];
                if (areaData && areaData.meses) {
                    Object.keys(areaData).forEach(key => {
                        if (key !== 'meses' && typeof areaData[key] === 'object' && areaData[key].limite !== undefined) {
                            const parametro = areaData[key];
                            
                            Object.keys(parametro).forEach(subKey => {
                                if (subKey !== 'limite' && Array.isArray(parametro[subKey])) {
                                    totalMuestras += parametro[subKey].length;
                                    parametro[subKey].forEach(valor => {
                                        if (checkCompliance(valor, parametro.limite)) {
                                            cumplimientos++;
                                        } else {
                                            noConformidades++;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            });

            const cumplimientoGeneral = totalMuestras > 0 ? Math.round((cumplimientos / totalMuestras) * 100) : 0;
            const accionesCorrectivas = currentData.planAccion ? currentData.planAccion.length : 0;

            document.getElementById('cumplimiento-porcentaje').textContent = cumplimientoGeneral + '%';
            document.getElementById('total-muestras').textContent = totalMuestras;
            document.getElementById('no-conformidades').textContent = noConformidades;
            document.getElementById('acciones-correctivas').textContent = accionesCorrectivas;
        }

        function initializeCharts(tabName) {
            if (tabName === 'resumen') {
                updateResumenGeneral();
                createResumenCharts();
            } else if (tabName === 'producto') {
                createProductoCharts();
            } else if (tabName === 'inertes') {
                createInertesCharts();
            } else if (tabName === 'vivas') {
                createVivasCharts();
            } else if (tabName === 'ambiental') {
                createAmbientalCharts();
            } else if (tabName === 'acciones') {
                updateAccionesTable();
            }
        }

        function createResumenCharts() {
            const ctxMensual = document.getElementById('cumplimientoMensual').getContext('2d');
            if (charts.cumplimientoMensual) charts.cumplimientoMensual.destroy();
            
            charts.cumplimientoMensual = new Chart(ctxMensual, {
                type: 'line',
                data: {
                    labels: currentData.productoEnProceso.meses,
                    datasets: [{
                        label: 'Cumplimiento (%)',
                        data: [95, 92, 88, 94, 96, 93, 91, 89, 97, 94, 95, 93],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje de Cumplimiento'
                            }
                        }
                    }
                }
            });

            const ctxArea = document.getElementById('cumplimientoArea').getContext('2d');
            if (charts.cumplimientoArea) charts.cumplimientoArea.destroy();
            
            charts.cumplimientoArea = new Chart(ctxArea, {
                type: 'doughnut',
                data: {
                    labels: ['Producto en Proceso', 'Superficies Inertes', 'Superficies Vivas', 'Ambiental'],
                    datasets: [{
                        data: [93, 95, 91, 97],
                        backgroundColor: ['#3B82F6', '#8B5CF6', '#F59E0B', '#10B981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function createProductoCharts() {
            const data = currentData.productoEnProceso;
            
            const ctxMesofilos = document.getElementById('productoMesofilos').getContext('2d');
            if (charts.productoMesofilos) charts.productoMesofilos.destroy();
            
            charts.productoMesofilos = new Chart(ctxMesofilos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.mesofilosAerobios.resultados,
                        backgroundColor: data.mesofilosAerobios.resultados.map(val => 
                            checkCompliance(val, data.mesofilosAerobios.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/g'
                            }
                        }
                    }
                }
            });

            const ctxColiformes = document.getElementById('productoColiformes').getContext('2d');
            if (charts.productoColiformes) charts.productoColiformes.destroy();
            
            charts.productoColiformes = new Chart(ctxColiformes, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.coliformesTotales.resultados,
                        backgroundColor: data.coliformesTotales.resultados.map(val => 
                            checkCompliance(val, data.coliformesTotales.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.coliformesTotales.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/g'
                            }
                        }
                    }
                }
            });

            const ctxEcoli = document.getElementById('productoEcoli').getContext('2d');
            if (charts.productoEcoli) charts.productoEcoli.destroy();
            
            charts.productoEcoli = new Chart(ctxEcoli, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.eColi.resultados,
                        backgroundColor: data.eColi.resultados.map(val => 
                            checkCompliance(val, data.eColi.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.eColi.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/g'
                            }
                        }
                    }
                }
            });
        }

        function createInertesCharts() {
            const data = currentData.superficiesInertes;
            
            const ctxMesofilos = document.getElementById('inertesMesofilos').getContext('2d');
            if (charts.inertesMesofilos) charts.inertesMesofilos.destroy();
            
            charts.inertesMesofilos = new Chart(ctxMesofilos, {
                type: 'line',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultado 1',
                        data: data.mesofilosAerobios.resultado1,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }, {
                        label: 'Resultado 2',
                        data: data.mesofilosAerobios.resultado2,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)'
                    }, {
                        label: 'Resultado 3',
                        data: data.mesofilosAerobios.resultado3,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)'
                    }, {
                        label: 'Resultado 4',
                        data: data.mesofilosAerobios.resultado4,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });

            const ctxColiformes = document.getElementById('inertesColiformes').getContext('2d');
            if (charts.inertesColiformes) charts.inertesColiformes.destroy();
            
            charts.inertesColiformes = new Chart(ctxColiformes, {
                type: 'line',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultado 1',
                        data: data.coliformesTotales.resultado1,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }, {
                        label: 'Resultado 2',
                        data: data.coliformesTotales.resultado2,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)'
                    }, {
                        label: 'Resultado 3',
                        data: data.coliformesTotales.resultado3,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)'
                    }, {
                        label: 'Resultado 4',
                        data: data.coliformesTotales.resultado4,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.coliformesTotales.limite),
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });
        }

        function createVivasCharts() {
            const data = currentData.superficiesVivas;
            
            const ctxMesofilos = document.getElementById('vivasMesofilos').getContext('2d');
            if (charts.vivasMesofilos) charts.vivasMesofilos.destroy();
            
            charts.vivasMesofilos = new Chart(ctxMesofilos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Manos en Proceso',
                        data: data.mesofilosAerobios.manosEnProceso,
                        backgroundColor: '#F59E0B'
                    }, {
                        label: 'Manos Lavadas',
                        data: data.mesofilosAerobios.manosLavadas,
                        backgroundColor: '#10B981'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });

            const ctxColiformes = document.getElementById('vivasColiformes').getContext('2d');
            if (charts.vivasColiformes) charts.vivasColiformes.destroy();
            
            charts.vivasColiformes = new Chart(ctxColiformes, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Manos en Proceso',
                        data: data.coliformesTotales.manosEnProceso,
                        backgroundColor: '#F59E0B'
                    }, {
                        label: 'Manos Lavadas',
                        data: data.coliformesTotales.manosLavadas,
                        backgroundColor: '#10B981'
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.coliformesTotales.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });

            const ctxAureus = document.getElementById('vivasAureus').getContext('2d');
            if (charts.vivasAureus) charts.vivasAureus.destroy();
            
            charts.vivasAureus = new Chart(ctxAureus, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Manos en Proceso',
                        data: data.sAureus.manosEnProceso,
                        backgroundColor: data.sAureus.manosEnProceso.map(val => 
                            checkCompliance(val, data.sAureus.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'Manos Lavadas',
                        data: data.sAureus.manosLavadas,
                        backgroundColor: data.sAureus.manosLavadas.map(val => 
                            checkCompliance(val, data.sAureus.limite) ? '#10B981' : '#EF4444'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≤'
                            }
                        }
                    }
                }
            });
        }

        function createAmbientalCharts() {
            const data = currentData.ambiental;
            
            const ctxMesofilos = document.getElementById('ambientalMesofilos').getContext('2d');
            if (charts.ambientalMesofilos) charts.ambientalMesofilos.destroy();
            
            charts.ambientalMesofilos = new Chart(ctxMesofilos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.mesofilosAerobios.resultados,
                        backgroundColor: data.mesofilosAerobios.resultados.map(val => 
                            checkCompliance(val, data.mesofilosAerobios.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mesofilosAerobios.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≥'
                            }
                        }
                    }
                }
            });

            const ctxMohos = document.getElementById('ambientalMohos').getContext('2d');
            if (charts.ambientalMohos) charts.ambientalMohos.destroy();
            
            charts.ambientalMohos = new Chart(ctxMohos, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.mohos.resultados,
                        backgroundColor: data.mohos.resultados.map(val => 
                            checkCompliance(val, data.mohos.limite) ? '#10B981' : '#EF4444'
                        )
                    }, {
                        label: 'L√≠mite',
                        data: new Array(data.meses.length).fill(data.mohos.limite),
                        type: 'line',
                        borderColor: '#EF4444',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≥'
                            }
                        }
                    }
                }
            });

            const ctxListeria = document.getElementById('ambientalListeria').getContext('2d');
            if (charts.ambientalListeria) charts.ambientalListeria.destroy();
            
            charts.ambientalListeria = new Chart(ctxListeria, {
                type: 'bar',
                data: {
                    labels: data.meses,
                    datasets: [{
                        label: 'Resultados',
                        data: data.listeria.resultados,
                        backgroundColor: data.listeria.resultados.map(val => 
                            checkCompliance(val, data.listeria.limite) ? '#10B981' : '#EF4444'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'UFC/cm¬≥'
                            }
                        }
                    }
                }
            });
        }

        function updateAccionesTable() {
            const tbody = document.getElementById('accionesTableBody');
            tbody.innerHTML = '';
            
            currentData.planAccion.forEach(accion => {
                const row = document.createElement('tr');
                const estadoClass = accion.estado === 'Cerrada' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accion.fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accion.muestreo}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${accion.resultado}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${accion.accionCorrectiva}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${accion.responsable}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${estadoClass}">
                            ${accion.estado}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function exportToPDF() {
            try {
                const originalText = document.querySelector('button[onclick="exportToPDF()"]').textContent;
                document.querySelector('button[onclick="exportToPDF()"]').textContent = '‚è≥ Generando PDF...';
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                let yPosition = 20;
                
                // Funci√≥n para agregar encabezado
                function addHeader() {
                    pdf.setFontSize(16);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('Dashboard Microbiologico 2025', 20, yPosition);
                    yPosition += 10;
                    
                    pdf.setFontSize(10);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(`Generado: ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES')}`, 20, yPosition);
                    yPosition += 15;
                }
                
                // Funci√≥n para verificar espacio y agregar nueva p√°gina si es necesario
                function checkPageSpace(neededSpace) {
                    if (yPosition + neededSpace > 280) {
                        pdf.addPage();
                        yPosition = 20;
                        addHeader();
                    }
                }
                
                addHeader();
                
                // RESUMEN GENERAL
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.text('RESUMEN GENERAL', 20, yPosition);
                yPosition += 10;
                
                pdf.setFontSize(11);
                const cumplimiento = document.getElementById('cumplimiento-porcentaje').textContent;
                const totalMuestras = document.getElementById('total-muestras').textContent;
                const noConformidades = document.getElementById('no-conformidades').textContent;
                const acciones = document.getElementById('acciones-correctivas').textContent;
                
                pdf.text(`Cumplimiento General: ${cumplimiento}`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Total de Muestras Analizadas: ${totalMuestras}`, 20, yPosition);
                yPosition += 7;
                pdf.text(`No Conformidades Detectadas: ${noConformidades}`, 20, yPosition);
                yPosition += 7;
                pdf.text(`Acciones Correctivas Implementadas: ${acciones}`, 20, yPosition);
                yPosition += 15;
                
                // PRODUCTO EN PROCESO
                checkPageSpace(50);
                pdf.setFontSize(14);
                pdf.text('PRODUCTO EN PROCESO', 20, yPosition);
                yPosition += 10;
                
                pdf.setFontSize(10);
                const productoData = currentData.productoEnProceso;
                
                // Tabla de datos de producto
                pdf.text('Mes', 20, yPosition);
                pdf.text('Mesofilos', 50, yPosition);
                pdf.text('Coliformes', 80, yPosition);
                pdf.text('E.coli', 110, yPosition);
                yPosition += 7;
                
                productoData.meses.forEach((mes, index) => {
                    checkPageSpace(7);
                    pdf.text(mes.substring(0, 3), 20, yPosition);
                    pdf.text(productoData.mesofilosAerobios.resultados[index].toString(), 50, yPosition);
                    pdf.text(productoData.coliformesTotales.resultados[index].toString(), 80, yPosition);
                    pdf.text(productoData.eColi.resultados[index].toString(), 110, yPosition);
                    yPosition += 5;
                });
                
                yPosition += 10;
                
                // SUPERFICIES INERTES
                checkPageSpace(30);
                pdf.setFontSize(14);
                pdf.text('SUPERFICIES INERTES', 20, yPosition);
                yPosition += 10;
                
                pdf.setFontSize(10);
                pdf.text('Promedio mensual de resultados de superficies inertes', 20, yPosition);
                yPosition += 7;
                
                const inertesData = currentData.superficiesInertes;
                inertesData.meses.forEach((mes, index) => {
                    checkPageSpace(5);
                    const promedioMesofilos = Math.round((
                        inertesData.mesofilosAerobios.resultado1[index] +
                        inertesData.mesofilosAerobios.resultado2[index] +
                        inertesData.mesofilosAerobios.resultado3[index] +
                        inertesData.mesofilosAerobios.resultado4[index]
                    ) / 4);
                    
                    pdf.text(`${mes}: Mesofilos promedio ${promedioMesofilos} UFC/cm¬≤`, 20, yPosition);
                    yPosition += 5;
                });
                
                yPosition += 10;
                
                // PLAN DE ACCI√ìN
                if (currentData.planAccion && currentData.planAccion.length > 0) {
                    checkPageSpace(30);
                    pdf.setFontSize(14);
                    pdf.text('PLAN DE ACCION', 20, yPosition);
                    yPosition += 10;
                    
                    pdf.setFontSize(10);
                    currentData.planAccion.forEach((accion, index) => {
                        checkPageSpace(20);
                        pdf.text(`Accion ${index + 1}:`, 20, yPosition);
                        yPosition += 5;
                        pdf.text(`Fecha: ${accion.fecha}`, 25, yPosition);
                        yPosition += 5;
                        pdf.text(`Tipo: ${accion.muestreo}`, 25, yPosition);
                        yPosition += 5;
                        pdf.text(`Estado: ${accion.estado}`, 25, yPosition);
                        yPosition += 8;
                    });
                }
                
                // Informaci√≥n de almacenamiento
                checkPageSpace(20);
                pdf.setFontSize(12);
                pdf.text('INFORMACION DE ALMACENAMIENTO', 20, yPosition);
                yPosition += 8;
                
                pdf.setFontSize(10);
                pdf.text('Los datos se almacenan localmente en tu navegador.', 20, yPosition);
                yPosition += 5;
                pdf.text('Para compartir datos, usa la funcion "Compartir Datos".', 20, yPosition);
                yPosition += 5;
                pdf.text('Los datos compartidos se mantienen sincronizados automaticamente.', 20, yPosition);
                
                pdf.save('Dashboard_Microbiologico_2025_Completo.pdf');
                
                document.querySelector('button[onclick="exportToPDF()"]').textContent = originalText;
                
                alert('‚úÖ PDF generado exitosamente con datos legibles');
                
            } catch (error) {
                document.querySelector('button[onclick="exportToPDF()"]').textContent = 'Exportar PDF';
                alert('‚ùå Error al generar el PDF: ' + error.message);
            }
        }

        function printFullReport() {
            window.print();
        }

        function initializeEditorForms() {
            generateProductoForm();
            generateInertesForm();
            generateVivasForm();
            generateAmbientalForm();
            generateAccionesForm();
        }

        function generateProductoForm() {
            const container = document.getElementById('productoForm');
            const data = currentData.productoEnProceso;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/g)
                        </label>
                        <input type="number" id="producto-mesofilos-${index}" 
                               value="${data.mesofilosAerobios.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üß™ Coliformes Totales (L√≠mite: ${data.coliformesTotales.limite.toLocaleString()} UFC/g)
                        </label>
                        <input type="number" id="producto-coliformes-${index}" 
                               value="${data.coliformesTotales.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.coliformesTotales.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‚ö†Ô∏è E. coli (L√≠mite: ${data.eColi.limite.toLocaleString()} UFC/g)
                        </label>
                        <input type="number" id="producto-ecoli-${index}" 
                               value="${data.eColi.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.eColi.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        function generateInertesForm() {
            const container = document.getElementById('inertesForm');
            const data = currentData.superficiesInertes;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                
                let mesofilosInputs = '';
                let coliformesInputs = '';
                
                for (let i = 1; i <= 4; i++) {
                    mesofilosInputs += `
                        <div class="mb-2">
                            <label class="block text-xs text-gray-600 mb-1">Resultado ${i}</label>
                            <input type="number" id="inertes-mesofilos-${i}-${index}" 
                                   value="${data.mesofilosAerobios[`resultado${i}`][index]}" 
                                   class="form-input w-full text-sm" 
                                   onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                                   placeholder="UFC/cm¬≤">
                        </div>
                    `;
                    
                    coliformesInputs += `
                        <div class="mb-2">
                            <label class="block text-xs text-gray-600 mb-1">Resultado ${i}</label>
                            <input type="number" id="inertes-coliformes-${i}-${index}" 
                                   value="${data.coliformesTotales[`resultado${i}`][index]}" 
                                   class="form-input w-full text-sm" 
                                   onchange="validateInput(this, ${data.coliformesTotales.limite})"
                                   placeholder="UFC/cm¬≤">
                        </div>
                    `;
                }
                
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        ${mesofilosInputs}
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            üß™ Coliformes Totales (L√≠mite: ${data.coliformesTotales.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        ${coliformesInputs}
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        function generateVivasForm() {
            const container = document.getElementById('vivasForm');
            const data = currentData.superficiesVivas;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos en Proceso</label>
                                <input type="number" id="vivas-mesofilos-proceso-${index}" 
                                       value="${data.mesofilosAerobios.manosEnProceso[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos Lavadas</label>
                                <input type="number" id="vivas-mesofilos-lavadas-${index}" 
                                       value="${data.mesofilosAerobios.manosLavadas[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                        </div>
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            üß™ Coliformes Totales (L√≠mite: ${data.coliformesTotales.limite.toLocaleString()} UFC/cm¬≤)
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos en Proceso</label>
                                <input type="number" id="vivas-coliformes-proceso-${index}" 
                                       value="${data.coliformesTotales.manosEnProceso[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.coliformesTotales.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos Lavadas</label>
                                <input type="number" id="vivas-coliformes-lavadas-${index}" 
                                       value="${data.coliformesTotales.manosLavadas[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.coliformesTotales.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                        </div>
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            ‚ö†Ô∏è S. Aureus (L√≠mite: ${data.sAureus.limite} UFC/cm¬≤)
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos en Proceso</label>
                                <input type="number" id="vivas-aureus-proceso-${index}" 
                                       value="${data.sAureus.manosEnProceso[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.sAureus.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Manos Lavadas</label>
                                <input type="number" id="vivas-aureus-lavadas-${index}" 
                                       value="${data.sAureus.manosLavadas[index]}" 
                                       class="form-input w-full text-sm" 
                                       onchange="validateInput(this, ${data.sAureus.limite})"
                                       placeholder="UFC/cm¬≤">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        function generateAmbientalForm() {
            const container = document.getElementById('ambientalForm');
            const data = currentData.ambiental;
            
            container.innerHTML = '';
            
            data.meses.forEach((mes, index) => {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                monthCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">üìÖ ${mes}</h4>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ü¶† Mes√≥filos Aerobios (L√≠mite: ${data.mesofilosAerobios.limite.toLocaleString()} UFC/cm¬≥)
                        </label>
                        <input type="number" id="ambiental-mesofilos-${index}" 
                               value="${data.mesofilosAerobios.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.mesofilosAerobios.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üçÑ Mohos (L√≠mite: ${data.mohos.limite.toLocaleString()} UFC/cm¬≥)
                        </label>
                        <input type="number" id="ambiental-mohos-${index}" 
                               value="${data.mohos.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.mohos.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                    
                    <div class="parameter-section">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ‚ö†Ô∏è Listeria (L√≠mite: ${data.listeria.limite} UFC/cm¬≥)
                        </label>
                        <input type="number" id="ambiental-listeria-${index}" 
                               value="${data.listeria.resultados[index]}" 
                               class="form-input w-full" 
                               onchange="validateInput(this, ${data.listeria.limite})"
                               placeholder="Ingrese resultado">
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        function generateAccionesForm() {
            const container = document.getElementById('accionesForm');
            container.innerHTML = '';
            
            if (currentData.planAccion && currentData.planAccion.length > 0) {
                currentData.planAccion.forEach((accion, index) => {
                    const actionCard = document.createElement('div');
                    actionCard.className = 'action-card';
                    actionCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-lg font-semibold text-gray-800">‚ö†Ô∏è Acci√≥n Correctiva #${index + 1}</h4>
                            <button onclick="removeAction(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Fecha</label>
                                <input type="date" id="accion-fecha-${index}" 
                                       value="${accion.fecha}" 
                                       class="form-input w-full">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üî¨ Tipo de Muestreo</label>
                                <select id="accion-muestreo-${index}" class="form-input w-full">
                                    <option value="PP" ${accion.muestreo === 'PP' ? 'selected' : ''}>Producto en Proceso</option>
                                    <option value="SI" ${accion.muestreo === 'SI' ? 'selected' : ''}>Superficies Inertes</option>
                                    <option value="SV" ${accion.muestreo === 'SV' ? 'selected' : ''}>Superficies Vivas</option>
                                    <option value="AM" ${accion.muestreo === 'AM' ? 'selected' : ''}>Ambiental</option>
                                </select>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">üìä Resultado</label>
                                <textarea id="accion-resultado-${index}" 
                                          class="form-input w-full h-20 resize-none" 
                                          placeholder="Describe el resultado que gener√≥ la no conformidad">${accion.resultado}</textarea>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">üîß Acci√≥n Correctiva</label>
                                <textarea id="accion-correctiva-${index}" 
                                          class="form-input w-full h-24 resize-none" 
                                          placeholder="Describe la acci√≥n correctiva implementada">${accion.accionCorrectiva}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üë§ Responsable</label>
                                <input type="text" id="accion-responsable-${index}" 
                                       value="${accion.responsable}" 
                                       class="form-input w-full" 
                                       placeholder="Nombre del responsable">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‚úÖ Fecha de Cierre</label>
                                <input type="date" id="accion-cierre-${index}" 
                                       value="${accion.fechaCierre}" 
                                       class="form-input w-full">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">üìã Estado</label>
                                <select id="accion-estado-${index}" class="form-input w-full">
                                    <option value="Abierta" ${accion.estado === 'Abierta' ? 'selected' : ''}>Abierta</option>
                                    <option value="En Proceso" ${accion.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                                    <option value="Cerrada" ${accion.estado === 'Cerrada' ? 'selected' : ''}>Cerrada</option>
                                </select>
                            </div>
                        </div>
                    `;
                    container.appendChild(actionCard);
                });
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">üìã No hay acciones correctivas registradas</p>
                        <p class="text-sm mt-2">Haz clic en "Nueva Acci√≥n" para agregar la primera acci√≥n correctiva</p>
                    </div>
                `;
            }
        }

        function validateInput(input, limit) {
            const value = parseFloat(input.value) || 0;
            
            input.classList.remove('error', 'success');
            
            if (value > limit) {
                input.classList.add('error');
            } else {
                input.classList.add('success');
            }
            
            setTimeout(autoSaveData, 500);
        }

        function addNewAction() {
            const newAction = {
                fecha: new Date().toISOString().split('T')[0],
                muestreo: 'PP',
                resultado: '',
                accionCorrectiva: '',
                responsable: '',
                fechaCierre: '',
                estado: 'Abierta'
            };
            
            if (!currentData.planAccion) {
                currentData.planAccion = [];
            }
            
            currentData.planAccion.push(newAction);
            generateAccionesForm();
        }

        function removeAction(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta acci√≥n correctiva?')) {
                currentData.planAccion.splice(index, 1);
                generateAccionesForm();
                autoSaveData();
            }
        }

        function collectActionData() {
            if (!currentData.planAccion) return;
            
            currentData.planAccion.forEach((accion, index) => {
                const fecha = document.getElementById(`accion-fecha-${index}`)?.value;
                const muestreo = document.getElementById(`accion-muestreo-${index}`)?.value;
                const resultado = document.getElementById(`accion-resultado-${index}`)?.value;
                const correctiva = document.getElementById(`accion-correctiva-${index}`)?.value;
                const responsable = document.getElementById(`accion-responsable-${index}`)?.value;
                const cierre = document.getElementById(`accion-cierre-${index}`)?.value;
                const estado = document.getElementById(`accion-estado-${index}`)?.value;
                
                if (fecha !== undefined) accion.fecha = fecha;
                if (muestreo !== undefined) accion.muestreo = muestreo;
                if (resultado !== undefined) accion.resultado = resultado;
                if (correctiva !== undefined) accion.accionCorrectiva = correctiva;
                if (responsable !== undefined) accion.responsable = responsable;
                if (cierre !== undefined) accion.fechaCierre = cierre;
                if (estado !== undefined) accion.estado = estado;
            });
        }

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const sharedDataLoaded = loadSharedData();
            
            if (!sharedDataLoaded) {
                loadSavedData();
            }
            
            showTab('resumen');
            
            const now = new Date().toLocaleString('es-ES');
            if (!document.getElementById('lastUpdate').textContent) {
                document.getElementById('lastUpdate').textContent = now;
            }
            
            console.log('‚úÖ Dashboard inicializado correctamente');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9787932bd38da0c7',t:'MTc1Njc1OTE0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
